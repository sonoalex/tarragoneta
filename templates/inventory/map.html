{% extends "base.html" %}

{% block title %}{{ _('Inventari') }} - Tarracograf{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
    #map { height: 600px; border-radius: 16px; z-index: 0; }
    
    /* Improved Leaflet popup styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
        padding: 0 !important;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
    }
    
    .leaflet-popup-content {
        margin: 8px !important;
        padding: 0 !important;
        min-width: 150px;
        max-width: 220px;
    }
    
    .leaflet-popup-tip {
        background: white !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
    }
    
    .leaflet-popup-close-button {
        width: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
        font-size: 16px !important;
        color: #666 !important;
        padding: 0 !important;
        margin: 6px 6px 0 0 !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.2s ease !important;
        text-align: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .leaflet-popup-close-button:hover {
        background: rgba(0, 0, 0, 0.08) !important;
        color: #000 !important;
        transform: scale(1.1);
    }
    
    /* Mobile-optimized popup styles */
    @media (max-width: 768px) {
        .leaflet-popup-content-wrapper {
            max-width: 200px !important;
        }
        .leaflet-popup-content {
            margin: 6px !important;
            font-size: 0.875rem !important;
            max-width: 200px !important;
        }
        .leaflet-popup-content h6 {
            font-size: 0.9rem !important;
            margin-bottom: 0.5rem !important;
        }
        .leaflet-popup-content p {
            font-size: 0.8rem !important;
            margin-bottom: 0.5rem !important;
        }
        .leaflet-popup-content img {
            max-width: 100% !important;
            max-height: 150px !important;
            object-fit: cover !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        .leaflet-popup-content .btn {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        .leaflet-popup-content .small {
            font-size: 0.7rem !important;
        }
    }
    
    /* Desktop popup image size */
    @media (min-width: 769px) {
        .leaflet-popup-content img {
            max-height: 120px !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
    }
    
    .category-filter {
        background: white;
        padding: 1rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
    .category-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        color: inherit;
    }
    .category-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .category-badge.active {
        background: var(--primary-green);
        color: white;
        font-weight: 600;
    }
    .stats-card {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5" style="background: var(--bg-cream); padding-top: 120px;">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 fw-bold mb-3">{{ _('Inventari') }}</h1>
                <p class="lead text-muted">{{ _('Mapa col·laboratiu per reportar i visualitzar problemes de la ciutat de Tarragona') }}</p>
            </div>
        </div>

        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h3 class="display-6 fw-bold text-primary">{{ total_items }}</h3>
                    <p class="text-muted mb-0">{{ _('Items reportats') }}</p>
                </div>
            </div>
            <div class="col-md-8">
                <div class="stats-card">
                    <h5 class="fw-bold mb-3">{{ _('Per categoria') }}</h5>
                    <div>
                        {% for cat_key, count in by_category.items() %}
                        {% set parts = cat_key.split('->') %}
                        {% set main_cat = parts[0] if parts|length > 0 else cat_key %}
                        {% set sub_cat = parts[1] if parts|length > 1 else '' %}
                        <span class="badge bg-secondary me-2 mb-2" style="font-size: 0.9rem; padding: 0.5rem 1rem;">
                            {% set icon_class, color_class = get_inventory_icon(main_cat, sub_cat) %}
                            <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>
                            {{ get_inventory_category_name(main_cat, sub_cat) }}: {{ count }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Category Filter -->
        <div class="category-filter">
            <h5 class="fw-bold mb-3">{{ _('Filtrar per categoria') }}</h5>
            
            <!-- Main Categories -->
            <div class="mb-3">
                <a href="{{ url_for('inventory.inventory_map') }}" 
                   class="category-badge {% if not selected_category %}active{% endif %}">
                    {{ _('Totes') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='coloms') }}" 
                   class="category-badge {% if selected_category == 'coloms' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('palomas') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Coloms') }}
                    {% if selected_category == 'coloms' and by_main_category.get('palomas') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('palomas', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='brossa') }}" 
                   class="category-badge {% if selected_category == 'brossa' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('basura') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Brossa') }}
                    {% if selected_category == 'brossa' and by_main_category.get('basura') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('basura', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='gossos') }}" 
                   class="category-badge {% if selected_category == 'gossos' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('perros') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Gossos') }}
                    {% if selected_category == 'gossos' and by_main_category.get('perros') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('perros', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat') }}" 
                   class="category-badge {% if selected_category == 'material_deteriorat' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('material_deteriorat') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Material Deteriorat') }}
                    {% if selected_category == 'material_deteriorat' and by_main_category.get('material_deteriorat') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('material_deteriorat', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='bruticia') }}" 
                   class="category-badge {% if selected_category == 'bruticia' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('bruticia') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Brutícia') }}
                    {% if selected_category == 'bruticia' and by_main_category.get('bruticia') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('bruticia', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='mobiliari_urba') }}" 
                   class="category-badge {% if selected_category == 'mobiliari_urba' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('mobiliari_urba') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Mobiliari Urbà') }}
                    {% if selected_category == 'mobiliari_urba' and by_main_category.get('mobiliari_urba') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('mobiliari_urba', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='vegetacio') }}" 
                   class="category-badge {% if selected_category == 'vegetacio' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('vegetacio') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Vegetació') }}
                    {% if selected_category == 'vegetacio' and by_main_category.get('vegetacio') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('vegetacio', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='infraestructura') }}" 
                   class="category-badge {% if selected_category == 'infraestructura' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('infraestructura') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Infraestructura') }}
                    {% if selected_category == 'infraestructura' and by_main_category.get('infraestructura') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_main_category.get('infraestructura', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            
            <!-- Subcategories (only show if a main category is selected) -->
            {% if selected_category == 'coloms' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Coloms') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='coloms') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='coloms', subcategory='niu') }}" 
                   class="category-badge {% if selected_subcategory == 'niu' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('palomas', 'nido') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Niu') }}
                    {% if by_subcategory.get('nido') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('nido', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='coloms', subcategory='excrement') }}" 
                   class="category-badge {% if selected_subcategory == 'excrement' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('palomas', 'excremento') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Excrement') }}
                    {% if by_subcategory.get('excremento') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('excremento', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='coloms', subcategory='plomes') }}" 
                   class="category-badge {% if selected_subcategory == 'plomes' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('palomas', 'plumas') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Plomes') }}
                    {% if by_subcategory.get('plumas') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('plumas', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'brossa' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Brossa') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='brossa') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='brossa', subcategory='escombreries_desbordades') }}" 
                   class="category-badge {% if selected_subcategory == 'escombreries_desbordades' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('basura', 'escombreries_desbordades') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Escombreries Desbordades') }}
                    {% if by_subcategory.get('escombreries_desbordades') or by_subcategory.get('basura_desbordada') %}
                        <span class="badge bg-light text-dark ms-1">{{ (by_subcategory.get('escombreries_desbordades', 0) + by_subcategory.get('basura_desbordada', 0)) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='brossa', subcategory='abocaments') }}" 
                   class="category-badge {% if selected_subcategory == 'abocaments' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('basura', 'vertidos') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Abocaments') }}
                    {% if by_subcategory.get('vertidos') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('vertidos', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'gossos' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Gossos') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='gossos') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='gossos', subcategory='excrements') }}" 
                   class="category-badge {% if selected_subcategory == 'excrements' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('perros', 'excrements') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Excrements') }}
                    {% if by_subcategory.get('excrements') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('excrements', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='gossos', subcategory='pixades') }}" 
                   class="category-badge {% if selected_subcategory == 'pixades' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('perros', 'pixades') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Pixades') }}
                    {% if by_subcategory.get('pixades') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('pixades', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'material_deteriorat' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Material Deteriorat') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat', subcategory='faroles') }}" 
                   class="category-badge {% if selected_subcategory == 'faroles' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('material_deteriorat', 'faroles') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Faroles') }}
                    {% if by_subcategory.get('faroles') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('faroles', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat', subcategory='bancs') }}" 
                   class="category-badge {% if selected_subcategory == 'bancs' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('material_deteriorat', 'bancs') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Bancs') }}
                    {% if by_subcategory.get('bancs') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('bancs', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat', subcategory='senyals') }}" 
                   class="category-badge {% if selected_subcategory == 'senyals' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('material_deteriorat', 'senyals') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Senyals') }}
                    {% if by_subcategory.get('senyals') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('senyals', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='material_deteriorat', subcategory='paviment') }}" 
                   class="category-badge {% if selected_subcategory == 'paviment' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('material_deteriorat', 'paviment') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Paviment') }}
                    {% if by_subcategory.get('paviment') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('paviment', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'bruticia' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Brutícia') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='bruticia') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='bruticia', subcategory='terra') }}" 
                   class="category-badge {% if selected_subcategory == 'terra' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('bruticia', 'terra') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Terra') }}
                    {% if by_subcategory.get('terra') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('terra', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='bruticia', subcategory='fulles') }}" 
                   class="category-badge {% if selected_subcategory == 'fulles' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('bruticia', 'fulles') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Fulles') }}
                    {% if by_subcategory.get('fulles') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('fulles', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='bruticia', subcategory='grafit') }}" 
                   class="category-badge {% if selected_subcategory == 'grafit' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('bruticia', 'grafit') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Grafit') }}
                    {% if by_subcategory.get('grafit') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('grafit', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'mobiliari_urba' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Mobiliari Urbà') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='mobiliari_urba') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='mobiliari_urba', subcategory='papereres') }}" 
                   class="category-badge {% if selected_subcategory == 'papereres' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('mobiliari_urba', 'papereres') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Papereres') }}
                    {% if by_subcategory.get('papereres') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('papereres', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='mobiliari_urba', subcategory='parades') }}" 
                   class="category-badge {% if selected_subcategory == 'parades' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('mobiliari_urba', 'parades') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Parades') }}
                    {% if by_subcategory.get('parades') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('parades', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='mobiliari_urba', subcategory='bancs') }}" 
                   class="category-badge {% if selected_subcategory == 'bancs' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('mobiliari_urba', 'bancs') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Bancs') }}
                    {% if by_subcategory.get('bancs') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('bancs', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'vegetacio' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Vegetació') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='vegetacio') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='vegetacio', subcategory='arbres') }}" 
                   class="category-badge {% if selected_subcategory == 'arbres' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('vegetacio', 'arbres') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Arbres') }}
                    {% if by_subcategory.get('arbres') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('arbres', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='vegetacio', subcategory='arbustos') }}" 
                   class="category-badge {% if selected_subcategory == 'arbustos' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('vegetacio', 'arbustos') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Arbustos') }}
                    {% if by_subcategory.get('arbustos') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('arbustos', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='vegetacio', subcategory='gespa') }}" 
                   class="category-badge {% if selected_subcategory == 'gespa' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('vegetacio', 'gespa') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Gespa') }}
                    {% if by_subcategory.get('gespa') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('gespa', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% elif selected_category == 'infraestructura' %}
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted d-block mb-2">{{ _('Subcategorías de Infraestructura') }}:</small>
                <a href="{{ url_for('inventory.inventory_map', category='infraestructura') }}" 
                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                    {{ _('Totes les subcategorías') }}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='infraestructura', subcategory='carreteres') }}" 
                   class="category-badge {% if selected_subcategory == 'carreteres' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('infraestructura', 'carreteres') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Carreteres') }}
                    {% if by_subcategory.get('carreteres') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('carreteres', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='infraestructura', subcategory='voreres') }}" 
                   class="category-badge {% if selected_subcategory == 'voreres' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('infraestructura', 'voreres') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Voreres') }}
                    {% if by_subcategory.get('voreres') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('voreres', 0) }}</span>
                    {% endif %}
                </a>
                <a href="{{ url_for('inventory.inventory_map', category='infraestructura', subcategory='enllumenat') }}" 
                   class="category-badge {% if selected_subcategory == 'enllumenat' %}active{% endif %}">
                    {% set icon_class, color_class = get_inventory_icon('infraestructura', 'enllumenat') %}
                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>{{ _('Enllumenat') }}
                    {% if by_subcategory.get('enllumenat') %}
                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get('enllumenat', 0) }}</span>
                    {% endif %}
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Map -->
        <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
            <div class="card-body p-0">
                <div id="map"></div>
            </div>
        </div>

        <!-- Attribution -->
        <div class="text-center mb-4">
            <p class="text-muted small mb-0">
                <i class="fas fa-info-circle me-1"></i>
                {{ _('Les zones han estat importades del') }} 
                <a href="https://geoportal.tarragona.cat/portal/apps/sites/#/geoportal-ajuntament-de-tarragona" 
                   target="_blank" 
                   rel="noopener noreferrer" 
                   class="text-decoration-none">
                    {{ _('Geoportal de Tarragona') }}
                </a>
            </p>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mb-4">
            {% if current_user.is_authenticated %}
            <a href="{{ url_for('inventory.report_item') }}" class="btn btn-primary btn-lg px-5" style="border-radius: 50px;">
                <i class="fas fa-plus me-2"></i>{{ _('Reportar nou item') }}
            </a>
            {% else %}
            <div class="alert alert-info d-inline-block" style="border-radius: 50px; padding: 1rem 2rem;">
                <i class="fas fa-info-circle me-2"></i>
                {{ _('Has de') }} <a href="{{ url_for('security.login') }}" class="alert-link">{{ _('iniciar sessió') }}</a> {{ _('per reportar items') }}
            </div>
            {% endif %}
            {% if current_user.has_role('admin') %}
            <a href="{{ url_for('inventory.admin_inventory') }}" class="btn btn-outline-secondary btn-lg px-5 ms-2" style="border-radius: 50px;">
                <i class="fas fa-cog me-2"></i>{{ _('Administrar') }}
            </a>
            {% endif %}
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize map centered on Tarragona
        // maxBounds se establecerá después de cargar el boundary
        var map = L.map('map', {
            center: [41.1189, 1.2445],
            zoom: 13,
            maxZoom: 19
        });
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // Colores para cada distrito (9 distritos) - Colores más vibrantes y distintos
        var districtColors = [
            '#E74C3C', // Districte 1 - Rojo fuerte
            '#1ABC9C', // Districte 2 - Turquesa fuerte
            '#3498DB', // Districte 3 - Azul fuerte
            '#E67E22', // Districte 4 - Naranja fuerte
            '#2ECC71', // Districte 5 - Verde fuerte
            '#F1C40F', // Districte 6 - Amarillo fuerte
            '#9B59B6', // Districte 7 - Púrpura fuerte
            '#16A085', // Districte 8 - Verde esmeralda
            '#D35400'  // Districte 9 - Naranja oscuro
        ];
        
        // Función para obtener color del distrito
        function getDistrictColor(districtCode) {
            var districtNum = parseInt(districtCode) - 1;
            if (districtNum >= 0 && districtNum < districtColors.length) {
                return districtColors[districtNum];
            }
            return '#CCCCCC'; // Color por defecto
        }
        
        // Función para convertir GeoJSON a Leaflet layer
        function geoJsonToLeaflet(geojson) {
            if (geojson.type === 'Polygon') {
                // Convertir coordenadas de [lng, lat] a [lat, lng] para Leaflet
                var latlngs = geojson.coordinates[0].map(function(coord) {
                    return [coord[1], coord[0]]; // [lat, lng]
                });
                return L.polygon(latlngs);
            } else if (geojson.type === 'MultiPolygon') {
                // Manejar MultiPolygon: crear un layer group con múltiples polígonos
                var layerGroup = L.layerGroup();
                geojson.coordinates.forEach(function(polygonCoords) {
                    var latlngs = polygonCoords[0].map(function(coord) {
                        return [coord[1], coord[0]]; // [lat, lng]
                    });
                    layerGroup.addLayer(L.polygon(latlngs));
                });
                return layerGroup;
            }
            return null;
        }
        
        // Cargar y dibujar secciones
        var sectionsLayer = L.layerGroup();
        fetch('{{ url_for("inventory.api_sections") }}')
            .then(response => response.json())
            .then(sections => {
                sections.forEach(function(section) {
                    if (section.geometry) {
                        var polygon = geoJsonToLeaflet(section.geometry);
                        if (polygon) {
                            var color = getDistrictColor(section.district_code);
                            
                            // Si es un LayerGroup (MultiPolygon), aplicar estilo a cada capa
                            if (polygon instanceof L.LayerGroup) {
                                polygon.eachLayer(function(layer) {
                                    layer.setStyle({
                                        fillColor: color,
                                        fillOpacity: 0.35,  // Más color para identificar secciones
                                        color: color,  // Borde del color del distrito
                                        weight: 0.8,  // Borde fino
                                        opacity: 0.85  // Borde ligeramente visible
                                    });
                                    layer.bindPopup(`
                                        <div style="min-width: 150px;">
                                            <h6 class="fw-bold mb-1">${section.district_name}</h6>
                                            <p class="small mb-0">${section.name}</p>
                                            <p class="small text-muted mb-0">Código: ${section.full_code}</p>
                                        </div>
                                    `);
                                });
                            } else {
                                // Si es un Polygon simple
                                polygon.setStyle({
                                    fillColor: color,
                                    fillOpacity: 0.35,  // Más color para identificar secciones
                                    color: color,  // Borde del color del distrito
                                    weight: 0.8,  // Borde fino
                                    opacity: 0.85  // Borde ligeramente visible
                                });
                                
                                // Popup con información de la sección
                                polygon.bindPopup(`
                                    <div style="min-width: 150px;">
                                        <h6 class="fw-bold mb-1">${section.district_name}</h6>
                                        <p class="small mb-0">${section.name}</p>
                                        <p class="small text-muted mb-0">Código: ${section.full_code}</p>
                                    </div>
                                `);
                            }
                            
                            sectionsLayer.addLayer(polygon);
                        }
                    }
                });
                
                // Añadir capa de secciones al mapa
                map.addLayer(sectionsLayer);
            })
            .catch(error => {
                console.error('Error loading sections:', error);
            });
        
        // Cargar y dibujar boundary de la ciudad
        var boundaryLayer = L.layerGroup();
        fetch('{{ url_for("inventory.api_boundary") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Boundary data received:', data);
                if (data.error) {
                    console.error('Boundary API error:', data.error);
                    return;
                }
                if (data.geometry) {
                    var polygon = geoJsonToLeaflet(data.geometry);
                    if (polygon) {
                        // Si es un LayerGroup (MultiPolygon), aplicar estilo a cada capa
                        if (polygon instanceof L.LayerGroup) {
                            polygon.eachLayer(function(layer) {
                                layer.setStyle({
                                    fillColor: '#4A9B5C',  // Verde de Tarracograf
                                    fillOpacity: 0.0,      // Sin relleno
                                    color: '#4A9B5C',      // Borde verde
                                    weight: 1.5,           // Borde más fino
                                    opacity: 0.7,          // Borde menos opaco
                                    dashArray: '10, 5'     // Línea punteada para diferenciarlo
                                });
                                layer.bindPopup(`
                                    <div style="min-width: 150px;">
                                        <h6 class="fw-bold mb-1">${data.name || 'Tarragona'}</h6>
                                        <p class="small text-muted mb-0">Límite de la ciudad</p>
                                        ${data.calculated_at ? `<p class="small text-muted mb-0">Calculado: ${new Date(data.calculated_at).toLocaleDateString()}</p>` : ''}
                                    </div>
                                `);
                            });
                        } else {
                            // Si es un Polygon simple
                            polygon.setStyle({
                                fillColor: '#4A9B5C',  // Verde de Tarracograf
                                fillOpacity: 0.0,      // Sin relleno
                                color: '#4A9B5C',      // Borde verde
                                weight: 1.5,           // Borde más fino
                                opacity: 0.7,          // Borde menos opaco
                                dashArray: '10, 5'     // Línea punteada para diferenciarlo
                            });
                            
                            // Popup con información del boundary
                            polygon.bindPopup(`
                                <div style="min-width: 150px;">
                                    <h6 class="fw-bold mb-1">${data.name || 'Tarragona'}</h6>
                                    <p class="small text-muted mb-0">Límite de la ciudad</p>
                                    ${data.calculated_at ? `<p class="small text-muted mb-0">Calculado: ${new Date(data.calculated_at).toLocaleDateString()}</p>` : ''}
                                </div>
                            `);
                        }
                        
                        boundaryLayer.addLayer(polygon);
                        map.addLayer(boundaryLayer);
                        console.log('Boundary added to map');
                        
                        // Establecer maxBounds para limitar el movimiento del mapa
                        if (data.bounds) {
                            var maxBounds = L.latLngBounds(
                                data.bounds.southwest,  // [lat, lng]
                                data.bounds.northeast   // [lat, lng]
                            );
                            map.setMaxBounds(maxBounds);
                            console.log('Map bounds restricted to:', maxBounds);
                        }
                    } else {
                        console.error('Failed to convert boundary geometry to Leaflet layer');
                    }
                } else {
                    console.error('No geometry in boundary data');
                }
            })
            .catch(error => {
                console.error('Error loading boundary:', error);
            });
        
        // Create marker cluster group
        var markers = L.markerClusterGroup();
        
        // Category icons mapping (matches Python get_inventory_icon function)
        function getCategoryIconInfo(category, subcategory) {
            var iconMapping = {
                // Palomas
                'palomas_nido': { icon: 'fa-home', color: '#007bff' },
                'palomas_excremento': { icon: 'fa-biohazard', color: '#dc3545' },
                'palomas_plumas': { icon: 'fa-feather', color: '#17a2b8' },
                'palomas_': { icon: 'fa-dove', color: '#007bff' },
                'palomas_otro': { icon: 'fa-dove', color: '#007bff' },
                // Basura
                'basura_escombreries_desbordades': { icon: 'fa-trash-alt', color: '#ffc107' },
                'basura_vertidos': { icon: 'fa-tint', color: '#dc3545' },
                'basura_': { icon: 'fa-trash', color: '#6c757d' },
                'basura_otro': { icon: 'fa-trash', color: '#6c757d' }
            };
            
            var key = (category || '') + '_' + (subcategory || '');
            if (iconMapping[key]) {
                return iconMapping[key];
            }
            // Fallback to category only
            key = (category || '') + '_';
            if (iconMapping[key]) {
                return iconMapping[key];
            }
            // Default fallback
            return { icon: 'fa-circle', color: '#6c757d' };
        }
        
        // Helper function to get image path for a specific size
        // Removes any existing size suffix and adds the requested one
        function getImagePathForSize(imagePath, size) {
            if (!imagePath) return null;
            // If it's already a full URL (S3), return as-is
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            // Find the last dot (extension)
            var lastDot = imagePath.lastIndexOf('.');
            if (lastDot === -1) {
                // No extension found, return original
                return imagePath;
            }
            
            var ext = imagePath.substring(lastDot);
            var nameWithPossibleSuffix = imagePath.substring(0, lastDot);
            
            // Remove any existing size suffix (_thumbnail, _medium, _large)
            // Pattern: _thumbnail, _medium, or _large at the end
            var baseName = nameWithPossibleSuffix.replace(/_?(thumbnail|medium|large)$/i, '');
            
            // Add the requested size suffix
            return baseName + '_' + size + ext;
        }
        
        // Category icons with optional image
        function getCategoryIcon(category, subcategory, imagePath) {
            var colors = {
                'excremento': '#8B4513',
                'nido': '#D2691E',
                'plumas': '#708090',
                'brossa_desbordada': '#FF6B35',
                'vertidos': '#4ECDC4',
                'otro': '#696969'
            };
            
            var iconInfo = getCategoryIconInfo(category, subcategory);
            var color = colors[subcategory] || iconInfo.color || '#696969';
            
            var size = 40; // Size for custom markers
            var iconSize = [size, size];
            var iconAnchor = [size/2, size/2];
            
            // If image exists, use it as marker
            if (imagePath) {
                return L.divIcon({
                    className: 'custom-marker-image',
                    html: `<div style="width: ${size}px; 
                                      height: ${size}px; 
                                      border-radius: 50%; 
                                      border: 3px solid white;
                                      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                                      overflow: hidden;
                                      background-color: ${color};
                                      display: flex;
                                      align-items: center;
                                      justify-content: center;">
                                <img src="${getImagePathForSize(imagePath, 'thumbnail')}" 
                                     style="width: 100%; 
                                            height: 100%; 
                                            object-fit: cover;
                                            border-radius: 50%;" 
                                     alt="${category}"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas ${iconInfo.icon}\\' style=\\'color: white; font-size: 18px;\\'></i>';">
                            </div>`,
                    iconSize: iconSize,
                    iconAnchor: iconAnchor
                });
            }
            
            // Default icon with Font Awesome
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; 
                                  width: ${size}px; 
                                  height: ${size}px; 
                                  border-radius: 50%; 
                                  border: 3px solid white;
                                  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                  display: flex;
                                  align-items: center;
                                  justify-content: center;">
                                <i class="fas ${iconInfo.icon}" style="color: white; font-size: 18px;"></i>
                            </div>`,
                iconSize: iconSize,
                iconAnchor: iconAnchor
            });
        }
        
        // Load items from API (usar valores de URL en catalán)
        var category = '{{ selected_category or "" }}';
        var subcategory = '{{ selected_subcategory or "" }}';
        var params = [];
        if (category) params.push(`category=${category}`);
        if (subcategory) params.push(`subcategory=${subcategory}`);
        var apiUrl = params.length > 0 ? 
            `{{ url_for('inventory.api_items') }}?${params.join('&')}` : 
            '{{ url_for('inventory.api_items') }}';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(items => {
                items.forEach(function(item) {
                    var voteButton = '';
                    var resolveButton = '';
                    var isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
                    const imageThumb = item.image_url_thumbnail || item.image_url || null;
                    const imageMedium = item.image_url || null;
                    
                    if (isAuthenticated) {
                        // Vote button (Encara hi és) - solo icono
                        if (item.has_voted) {
                            voteButton = `
                                <button class="btn btn-sm btn-primary vote-btn" disabled style="padding: 0.25rem 0.5rem;" title="+1">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `;
                        } else {
                            voteButton = `
                                <button class="btn btn-sm btn-primary vote-btn" data-item-id="${item.id}" style="padding: 0.25rem 0.5rem;" title="+1">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `;
                        }
                        
                        // Resolve button (Ya no está) - solo icono
                        resolveButton = `
                            <button class="btn btn-sm ${item.has_resolved ? 'btn-warning' : 'btn-warning'} resolve-btn rounded-pill" ${item.has_resolved ? 'disabled' : ''} ${item.has_resolved ? '' : `data-item-id="${item.id}"`} style="padding: 0.25rem 0.5rem;" title="{{ _('Ja no hi és') }}">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        `;
                    }
                    
                    var iconInfo = getCategoryIconInfo(item.category, item.subcategory);
                    // Detect mobile screen size
                    var isMobile = window.innerWidth <= 768;
                    var popupMinWidth = isMobile ? '150px' : '180px';
                    
                    // Truncate address to max 25 characters
                    var truncatedAddress = item.address ? (item.address.length > 25 ? item.address.substring(0, 25) + '...' : item.address) : '';
                    
                    var popupContent = `
                        <div style="min-width: ${popupMinWidth}; max-width: ${isMobile ? '200px' : '220px'};">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas ${iconInfo.icon} ${iconInfo.color ? 'text-primary' : ''} me-1" style="font-size: 0.85rem;"></i>
                                <h6 class="fw-bold mb-0" style="font-size: ${isMobile ? '0.75rem' : '0.8rem'}; line-height: 1.2;">${item.full_category}</h6>
                            </div>
                            ${truncatedAddress ? `<p class="small text-muted mb-1" style="font-size: ${isMobile ? '0.65rem' : '0.7rem'}; line-height: 1.2;"><i class="fas fa-map-marker-alt" style="font-size: 0.6rem;"></i> ${truncatedAddress}</p>` : ''}
                            ${imageThumb ? `<img src="${imageThumb}" style="width: 100%; max-height: 70px; border-radius: 6px; margin: 0.25rem 0; object-fit: cover;" />` : ''}
                            <div class="d-flex justify-content-between align-items-center mt-1 pt-1 border-top" style="padding-top: 0.25rem !important; margin-top: 0.25rem !important; font-size: ${isMobile ? '0.65rem' : '0.7rem'} !important;">
                                <span class="text-muted">
                                    <i class="fas fa-star text-warning" style="font-size: 0.65rem;"></i>
                                    <strong>${item.importance_count || 0}</strong>
                                </span>
                                ${item.resolved_count > 0 ? `<span class="text-warning"><i class="fas fa-times-circle" style="font-size: 0.65rem;"></i> <strong>${item.resolved_count}</strong></span>` : ''}
                                <a href="/inventory/${item.id}" class="text-primary" style="font-size: 0.7rem;" title="{{ _('Veure detalls') }}">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                            ${voteButton || resolveButton ? `
                                <div class="mt-1 pt-1 border-top d-flex gap-1 justify-content-center" style="padding-top: 0.25rem !important; margin-top: 0.25rem !important;">
                                    ${voteButton || ''}
                                    ${resolveButton || ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    var marker = L.marker([item.latitude, item.longitude], {
                        icon: getCategoryIcon(item.category, item.subcategory, imageThumb)
                    });
                    
                    marker.bindPopup(popupContent, { autoClose: true, closeOnClick: false });
                    markers.addLayer(marker);
                });
                
                map.addLayer(markers);
                
                // Fit map to show all markers
                if (items.length > 0) {
                    var group = new L.featureGroup(markers.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                // Handle vote and resolve button clicks
                map.on('popupopen', function(e) {
                    var popup = e.popup;
                    var content = popup.getContent();
                    
                    // Re-bind vote buttons after popup opens
                    setTimeout(function() {
                        document.querySelectorAll('.vote-btn').forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                var itemId = this.getAttribute('data-item-id');
                                voteForItem(itemId, this);
                            });
                        });
                        
                        // Re-bind resolve buttons after popup opens
                        document.querySelectorAll('.resolve-btn').forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                var itemId = this.getAttribute('data-item-id');
                                resolveItem(itemId, this);
                            });
                        });
                    }, 100);
                });
            })
            .catch(error => {
                console.error('Error loading inventory items:', error);
            });
        
        // Vote function
        function voteForItem(itemId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Processant...") }}';
            
            // Get CSRF token from meta tag or form
            var csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                           document.querySelector('input[name="csrf_token"]')?.value || 
                           '{{ csrf_token() }}';
            
            fetch(`{{ url_for('inventory.vote_item', item_id=0) }}`.replace('0', itemId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${encodeURIComponent(csrfToken)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update vote button - keep it active but disabled
                    button.disabled = true;
                    // Keep btn-primary class to show it's selected
                    button.innerHTML = '+1';
                    
                    // Update importance count in popup
                    var popupContent = button.closest('.leaflet-popup-content');
                    var countElement = popupContent.querySelector('.d-flex .small strong');
                    if (!countElement) {
                        // Try finding it in the stats section
                        var statsSection = button.closest('.border-top').previousElementSibling;
                        if (statsSection) {
                            countElement = statsSection.querySelector('strong');
                        }
                    }
                    if (countElement) {
                        countElement.textContent = data.importance_count;
                    }
                    
                    // Disable resolve button if it exists (mutually exclusive)
                    var resolveBtn = button.closest('.d-flex').querySelector('.resolve-btn');
                    if (resolveBtn) {
                        resolveBtn.disabled = true;
                        resolveBtn.classList.remove('btn-warning');
                        resolveBtn.classList.add('btn-outline-warning');
                        // Ensure rounded-pill class is present
                        if (!resolveBtn.classList.contains('rounded-pill')) {
                            resolveBtn.classList.add('rounded-pill');
                        }
                    }
                    
                    // Update resolved count if it changed
                    if (data.resolved_count !== undefined) {
                        var popupContent = button.closest('.leaflet-popup-content');
                        var resolvedCountDiv = popupContent.querySelector('.resolved-count-display');
                        if (resolvedCountDiv && data.resolved_count === 0) {
                            resolvedCountDiv.remove();
                        } else if (data.resolved_count > 0) {
                            if (!resolvedCountDiv) {
                                resolvedCountDiv = document.createElement('div');
                                resolvedCountDiv.className = 'mt-2 pt-2 border-top resolved-count-display';
                                var buttonsDiv = button.closest('.d-flex').closest('.border-top');
                                if (buttonsDiv) {
                                    buttonsDiv.parentNode.insertBefore(resolvedCountDiv, buttonsDiv);
                                }
                            }
                            resolvedCountDiv.innerHTML = `
                                <span class="small text-warning">
                                    <i class="fas fa-times-circle me-1"></i>
                                    <strong>${data.resolved_count}</strong> {{ _('reportat que ja no hi és') }}
                                </span>
                            `;
                        }
                    }
                    
                    // Show success message
                    var alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    button.closest('.d-flex').closest('.border-top').after(alert);
                } else {
                    alert(data.error || '{{ _("Error al votar") }}');
                    button.disabled = false;
                    button.innerHTML = '+1';
                }
            })
            .catch(error => {
                console.error('Error voting:', error);
                alert('{{ _("Error al votar. Intenta-ho de nou.") }}');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-thumbs-up me-1"></i>{{ _("Confirmar importància") }}';
            });
        }
        
        // Resolve function (ya no está)
        function resolveItem(itemId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Processant...") }}';
            
            // Get CSRF token
            var csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                           document.querySelector('input[name="csrf_token"]')?.value || 
                           '{{ csrf_token() }}';
            
            fetch(`{{ url_for('inventory.resolve_item', item_id=0) }}`.replace('0', itemId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${encodeURIComponent(csrfToken)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update resolve button state - keep it active but disabled
                    button.disabled = true;
                    // Keep btn-warning class to show it's selected
                    // Ensure rounded-pill class is present
                    if (!button.classList.contains('rounded-pill')) {
                        button.classList.add('rounded-pill');
                    }
                    
                    // Disable vote button if it exists (mutually exclusive)
                    var voteBtn = button.closest('.d-flex').querySelector('.vote-btn');
                    if (voteBtn) {
                        voteBtn.disabled = true;
                        voteBtn.classList.remove('btn-primary');
                        voteBtn.classList.add('btn-outline-primary');
                    }
                    
                    // Update importance count if it changed
                    if (data.importance_count !== undefined) {
                        var popupContent = button.closest('.leaflet-popup-content');
                        var countElement = popupContent.querySelector('.d-flex .small strong');
                        if (!countElement) {
                            // Try finding it in the stats section
                            var statsSection = button.closest('.border-top').previousElementSibling;
                            if (statsSection) {
                                countElement = statsSection.querySelector('strong');
                            }
                        }
                        if (countElement) {
                            countElement.textContent = data.importance_count;
                        }
                    }
                    
                    // Update resolved count in popup
                    var popupContent = button.closest('.leaflet-popup-content');
                    if (popupContent) {
                        // Find or create resolved count display
                        var resolvedCountDiv = popupContent.querySelector('.resolved-count-display');
                        if (!resolvedCountDiv) {
                            // Create it if it doesn't exist
                            resolvedCountDiv = document.createElement('div');
                            resolvedCountDiv.className = 'mt-2 pt-2 border-top resolved-count-display';
                            var buttonsDiv = button.closest('.d-flex').closest('.border-top');
                            if (buttonsDiv) {
                                buttonsDiv.parentNode.insertBefore(resolvedCountDiv, buttonsDiv);
                            }
                        }
                        resolvedCountDiv.innerHTML = `
                            <span class="small text-warning">
                                <i class="fas fa-times-circle me-1"></i>
                                <strong>${data.resolved_count}</strong> {{ _('reportat que ja no hi és') }}
                            </span>
                        `;
                    }
                    
                    // If auto-resolved, show message and reload items
                    if (data.auto_resolved) {
                        setTimeout(function() {
                            alert('{{ _("Aquest item s\'ha tancat automàticament després de múltiples confirmacions que ja no hi és.") }}');
                            // Reload items to update map
                            location.reload();
                        }, 1500);
                    } else {
                        // Show success message
                        var alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alert.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        button.closest('.d-flex').closest('.border-top').after(alert);
                    }
                } else {
                    // Mostrar error inline en el popup
                    var popup = button.closest('.leaflet-popup-content');
                    if (popup) {
                        var alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>${data.error || '{{ _("Error al reportar") }}'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        popup.appendChild(alertDiv);
                    } else {
                        alert(data.error || '{{ _("Error al reportar") }}');
                    }
                    button.disabled = false;
                    // Ensure rounded-pill class is present
                    if (!button.classList.contains('rounded-pill')) {
                        button.classList.add('rounded-pill');
                    }
                    button.innerHTML = '<i class="fas fa-times-circle me-1"></i>{{ _("Ja no hi és") }}';
                }
            })
            .catch(error => {
                console.error('Error resolving item:', error);
                var popup = button.closest('.leaflet-popup-content');
                if (popup) {
                    var alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ _("Error al reportar. Intenta-ho de nou.") }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    popup.appendChild(alertDiv);
                } else {
                    alert('{{ _("Error al reportar. Intenta-ho de nou.") }}');
                }
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-times-circle me-1"></i>{{ _("Ja no hi és") }}';
            });
        }
    });
</script>
{% endblock %}

