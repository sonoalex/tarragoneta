{% extends "base.html" %}

{% block title %}{{ _('Inventari') }} - Tarracograf{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<style>
    #map { height: 70vh; min-height: 500px; border-radius: 16px; z-index: 0; }
    
    /* Improved Leaflet popup styles */
    .leaflet-popup-content-wrapper {
        border-radius: 12px !important;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12) !important;
        padding: 0 !important;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
    }
    
    .leaflet-popup-content {
        margin: 8px !important;
        padding: 0 !important;
        min-width: 150px;
        max-width: 220px;
    }
    
    .leaflet-popup-tip {
        background: white !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1) !important;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
    }
    
    .leaflet-popup-close-button {
        width: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
        font-size: 16px !important;
        color: #666 !important;
        padding: 0 !important;
        margin: 6px 6px 0 0 !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.95) !important;
        transition: all 0.2s ease !important;
        text-align: center !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
    }
    
    .leaflet-popup-close-button:hover {
        background: rgba(0, 0, 0, 0.08) !important;
        color: #000 !important;
        transform: scale(1.1);
    }
    
    /* Mobile-optimized popup styles */
    @media (max-width: 768px) {
        .leaflet-popup-content-wrapper {
            max-width: 200px !important;
        }
        .leaflet-popup-content {
            margin: 6px !important;
            font-size: 0.875rem !important;
            max-width: 200px !important;
        }
        .leaflet-popup-content h6 {
            font-size: 0.9rem !important;
            margin-bottom: 0.5rem !important;
        }
        .leaflet-popup-content p {
            font-size: 0.8rem !important;
            margin-bottom: 0.5rem !important;
        }
        .leaflet-popup-content img {
            max-width: 100% !important;
            max-height: 150px !important;
            object-fit: cover !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
        .leaflet-popup-content .btn {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
        }
        .leaflet-popup-content .small {
            font-size: 0.7rem !important;
        }
    }
    
    /* Desktop popup image size */
    @media (min-width: 769px) {
        .leaflet-popup-content img {
            max-height: 120px !important;
            display: block !important;
            margin-left: auto !important;
            margin-right: auto !important;
        }
    }
    
    .category-filter {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        /* Mejorar la UX del scroll */
        scrollbar-width: thin;
        scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    /* Estilos del scrollbar para mejor visibilidad */
    .category-filter::-webkit-scrollbar {
        width: 6px;
    }
    
    .category-filter::-webkit-scrollbar-track {
        background: transparent;
        border-radius: 10px;
    }
    
    .category-filter::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
    }
    
    .category-filter::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }
    
    /* Indicador visual cuando hay scroll disponible */
    .category-filter::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 20px;
        background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.8));
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s;
    }
    
    .category-filter.scrollable::after {
        opacity: 1;
    }
    
    /* Asegurar que el navbar siempre esté por encima del sidebar */
    #mainNavbar {
        z-index: 1030 !important;
    }
    
    .stats-summary {
        padding-bottom: 0.75rem;
    }
    
    .category-stat-item {
        border: 1px solid transparent;
    }
    
    .category-stat-item:hover {
        background: rgba(13, 110, 253, 0.08) !important;
        border-color: rgba(13, 110, 253, 0.2);
        transform: translateX(2px);
    }
    
    .category-stat-item.active {
        border-color: rgba(13, 110, 253, 0.3);
    }
    .category-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        margin: 0.25rem;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
        color: inherit;
    }
    .category-badge:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .category-badge.active {
        background: var(--primary-green);
        color: white;
        font-weight: 600;
    }
    .stats-card {
        background: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1.5rem;
    }

    /* Icono dels punts de contenedors */
    .container-point-icon-wrapper {
        pointer-events: none;
    }
    .container-point-icon {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        color: #ffffff;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
    }
    .container-point-icon.normal {
        background-color: #4A9B5C;
    }
    .container-point-icon.overflow {
        background-color: #FF3B3B;
    }
</style>
{% endblock %}

{% block content %}
<section class="py-5" style="background: var(--bg-cream); padding-top: 120px;">
    <div class="container">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="display-5 fw-bold mb-3">{{ _('Inventari') }}</h1>
                <p class="lead text-muted">{{ _('Mapa col·laboratiu per reportar i visualitzar problemes de la ciutat de Tarragona') }}</p>
            </div>
        </div>

        <!-- Layout principal: Sidebar izquierdo + Mapa derecho -->
        <div class="row">
            <!-- Sidebar de filtros (col-3) -->
            <div class="col-lg-3 col-md-4 mb-4" style="position: relative;">
                <div class="category-filter" style="position: sticky; top: 120px; z-index: 1020;">
                    <!-- Statistics Summary -->
                    <div class="stats-summary mb-3 pb-3 border-bottom">
                        <div class="d-flex align-items-center justify-content-between p-2 rounded" style="background: #f8f9fa; border: 1px solid #e9ecef;">
                            <div class="d-flex align-items-center">
                                <div class="d-inline-flex align-items-center justify-content-center rounded-circle me-2" style="width: 40px; height: 40px; background: #198754;">
                                    <i class="fas fa-list text-white" style="font-size: 0.9rem;"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark" style="font-size: 1.1rem; line-height: 1.2;">{{ total_items }}</div>
                                    <div class="text-muted" style="font-size: 0.7rem; line-height: 1;">{{ _('Items reportats') }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Categories -->
                        {% if by_main_category and db_categories %}
                            {# Mostrar categorías con items, ordenadas por count (simplificado) #}
                            {% set shown_count = 0 %}
                            {% set max_show = 5 %}
                            <div class="mt-2">
                                <small class="text-muted text-uppercase fw-bold d-block mb-1" style="font-size: 0.65rem; letter-spacing: 0.5px;">{{ _('Top categories') }}</small>
                                {# Iterar sobre todas las categorías y mostrar las que tienen más items #}
                                {% for cat in db_categories %}
                                    {% if shown_count < max_show %}
                                        {% set count = by_main_category.get(cat.code, 0) %}
                                        {% if count > 0 %}
                                            {% set shown_count = shown_count + 1 %}
                                            {% set cat_code = cat.code %}
                                            {% set cat_obj = cat %}
                                            <a href="{{ url_for('inventory.inventory_map', category=cat_code) }}" 
                                               class="d-flex align-items-center justify-content-between p-1.5 mb-1 rounded text-decoration-none category-stat-item {% if selected_category == cat_code %}active{% endif %}"
                                               style="background: {% if selected_category == cat_code %}rgba(13, 110, 253, 0.1){% else %}rgba(0, 0, 0, 0.03){% endif %}; transition: all 0.2s; padding: 0.4rem 0.75rem;">
                                                <div class="d-flex align-items-center">
                                                    {% if cat_obj.icon and not cat_obj.icon.startswith('fa-') %}
                                                        <span style="font-size: 1rem; margin-right: 0.4rem;">{{ cat_obj.icon }}</span>
                                                    {% else %}
                                                        {% set icon_class, color_class = get_inventory_icon(cat_code) %}
                                                        <i class="fas {{ icon_class }} {{ color_class }}" style="font-size: 0.9rem; margin-right: 0.4rem;"></i>
                                                    {% endif %}
                                                    <span class="small fw-medium" style="color: {% if selected_category == cat_code %}#0d6efd{% else %}inherit{% endif %}; font-size: 0.8rem;">{{ get_inventory_category_name(cat_code) }}</span>
                                                </div>
                                                <span class="badge {% if selected_category == cat_code %}bg-primary{% else %}bg-secondary{% endif %} rounded-pill" style="font-size: 0.7rem; padding: 0.2rem 0.5rem;">{{ count }}</span>
                                            </a>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    
                    <h5 class="fw-bold mb-3">{{ _('Filtrar per categoria') }}</h5>
                    
                    <!-- Main Categories -->
                    <div class="mb-3">
                        <a href="{{ url_for('inventory.inventory_map') }}" 
                           class="category-badge {% if not selected_category %}active{% endif %}">
                            {{ _('Totes') }}
                        </a>
                        {% if db_categories %}
                            {% for cat in db_categories %}
                            <a href="{{ url_for('inventory.inventory_map', category=cat.code) }}" 
                               class="category-badge {% if selected_category == cat.code %}active{% endif %}">
                                {% if cat.icon and not cat.icon.startswith('fa-') %}
                                    {# Es un emoji #}
                                    <span style="font-size: 1rem;">{{ cat.icon }}</span>
                                {% else %}
                                    {% set icon_class, color_class = get_inventory_icon(cat.code) %}
                                    <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>
                                {% endif %}
                                {{ get_inventory_category_name(cat.code) }}
                                {% if selected_category == cat.code %}
                                    <span class="badge bg-light text-dark ms-1">{{ by_main_category.get(cat.code, 0) }}</span>
                                {% endif %}
                            </a>
                            {% endfor %}
                        {% endif %}
                    </div>
                    
                    <!-- Subcategories (only show if a main category is selected) -->
                    {% if selected_category and subcategories_by_parent %}
                        {% if subcategories_by_parent.get(selected_category) %}
                            <div class="mt-3 pt-3 border-top">
                                <small class="text-muted d-block mb-2">{{ _('Subcategorías de') }} {{ get_inventory_category_name(selected_category) }}:</small>
                                <a href="{{ url_for('inventory.inventory_map', category=selected_category) }}" 
                                   class="category-badge {% if not selected_subcategory %}active{% endif %}">
                                    {{ _('Totes les subcategorías') }}
                                </a>
                                {% for subcat in subcategories_by_parent.get(selected_category, []) %}
                                <a href="{{ url_for('inventory.inventory_map', category=selected_category, subcategory=subcat.code) }}" 
                                   class="category-badge {% if selected_subcategory == subcat.code %}active{% endif %}">
                                    {% if subcat.icon and not subcat.icon.startswith('fa-') %}
                                        {# Es un emoji #}
                                        <span style="font-size: 1rem;">{{ subcat.icon }}</span>
                                    {% else %}
                                        {% set icon_class, color_class = get_inventory_icon(selected_category, subcat.code) %}
                                        <i class="fas {{ icon_class }} {{ color_class }} me-1"></i>
                                    {% endif %}
                                    {{ subcat.get_name() }}
                                    {% if selected_subcategory == subcat.code and by_subcategory.get(subcat.code) %}
                                        <span class="badge bg-light text-dark ms-1">{{ by_subcategory.get(subcat.code, 0) }}</span>
                                    {% endif %}
                                </a>
                                {% endfor %}
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Mapa y contenido principal (col-9) -->
            <div class="col-lg-9 col-md-8">
                <!-- Map -->
                <div class="card border-0 shadow-sm mb-4" style="border-radius: 16px; overflow: hidden;">
                    <div class="card-body p-0">
                        <div id="map"></div>
                    </div>
                </div>

                <!-- Attribution -->
                <div class="text-center mb-4">
                    <p class="text-muted small mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ _('Les zones han estat importades del') }} 
                        <a href="https://geoportal.tarragona.cat/portal/apps/sites/#/geoportal-ajuntament-de-tarragona" 
                           target="_blank" 
                           rel="noopener noreferrer" 
                           class="text-decoration-none">
                            {{ _('Geoportal de Tarragona') }}
                        </a>
                    </p>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-center align-items-center flex-wrap gap-2 mb-4">
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('inventory.report_item') }}" class="btn btn-primary btn-lg px-4 py-2" style="border-radius: 50px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-plus me-2"></i>{{ _('Reportar nou item') }}
                    </a>
                    {% else %}
                    <div class="alert alert-info d-inline-flex align-items-center" style="border-radius: 50px; padding: 0.75rem 1.5rem; margin: 0;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span>{{ _('Has de') }} <a href="{{ url_for('security.login') }}" class="alert-link">{{ _('iniciar sessió') }}</a> {{ _('per reportar items') }}</span>
                    </div>
                    {% endif %}
                    {% if current_user.has_role('admin') %}
                    <a href="{{ url_for('inventory.admin_inventory') }}" class="btn btn-outline-secondary btn-lg px-4 py-2" style="border-radius: 50px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-cog me-2"></i>{{ _('Administrar') }}
                    </a>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                        {% if current_user.has_role('admin') or current_user.has_role('section_responsible') %}
                        <button id="toggle-container-mode" class="btn btn-outline-primary px-3 py-2" type="button" style="border-radius: 50px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-trash-alt me-1"></i>{{ _('Mode punts de contenidors') }}
                        </button>
                        <button id="create-container-from-location" class="btn btn-outline-success px-3 py-2" type="button" style="border-radius: 50px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-crosshairs me-1"></i>{{ _('Crear punt des de la meva ubicació') }}
                        </button>
                        {% else %}
                        <button id="suggest-container-from-location" class="btn btn-outline-warning px-3 py-2" type="button" style="border-radius: 50px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-lightbulb me-1"></i>{{ _('Aquí hi ha contenidors') }}
                        </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Detectar si el sidebar tiene scroll y mostrar indicador
        const categoryFilter = document.querySelector('.category-filter');
        if (categoryFilter) {
            function checkScrollable() {
                if (categoryFilter.scrollHeight > categoryFilter.clientHeight) {
                    categoryFilter.classList.add('scrollable');
                } else {
                    categoryFilter.classList.remove('scrollable');
                }
            }
            
            // Verificar al cargar y cuando cambie el contenido
            checkScrollable();
            categoryFilter.addEventListener('scroll', checkScrollable);
            
            // Observar cambios en el contenido (cuando se muestran/ocultan subcategorías)
            const observer = new MutationObserver(checkScrollable);
            observer.observe(categoryFilter, { childList: true, subtree: true });
        }
        
        // Initialize map centered on Tarragona
        // maxBounds se establecerá después de cargar el boundary
        const map = L.map('map', {
            center: [41.1189, 1.2445],
            zoom: 13,
            maxZoom: 19
        });
        
        // Pane específic per als punts de contenidors (per estar per sobre de seccions)
        map.createPane('containerPane');
        const containerPane = map.getPane('containerPane');
        containerPane.style.zIndex = 650; // per sobre d'overlay i markers
        // Per defecte, no intercepta clics: així es pot clicar el marker d'inventari que hi ha a sota
        containerPane.style.pointerEvents = 'none';
        
        // Capa base: OpenStreetMap
        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
        });
        
        // Añadir capa base por defecto
        osmLayer.addTo(map);
        
        // Colores para cada distrito (9 distritos) - Colores más vibrantes y distintos
        const districtColors = [
            '#E74C3C', // Districte 1 - Rojo fuerte
            '#1ABC9C', // Districte 2 - Turquesa fuerte
            '#3498DB', // Districte 3 - Azul fuerte
            '#E67E22', // Districte 4 - Naranja fuerte
            '#2ECC71', // Districte 5 - Verde fuerte
            '#F1C40F', // Districte 6 - Amarillo fuerte
            '#9B59B6', // Districte 7 - Púrpura fuerte
            '#16A085', // Districte 8 - Verde esmeralda
            '#D35400'  // Districte 9 - Naranja oscuro
        ];
        
        // Función para obtener color del distrito
        function getDistrictColor(districtCode) {
            const districtNum = parseInt(districtCode) - 1;
            if (districtNum >= 0 && districtNum < districtColors.length) {
                return districtColors[districtNum];
            }
            return '#CCCCCC'; // Color por defecto
        }
        
        // Función para convertir GeoJSON a Leaflet layer
        function geoJsonToLeaflet(geojson, options) {
            options = options || {};
            if (geojson.type === 'Polygon') {
                // Convertir coordenadas de [lng, lat] a [lat, lng] para Leaflet
                const latlngs = geojson.coordinates[0].map(function(coord) {
                    return [coord[1], coord[0]]; // [lat, lng]
                });
                return L.polygon(latlngs, options);
            } else if (geojson.type === 'MultiPolygon') {
                // Manejar MultiPolygon: crear un layer group con múltiples polígonos
                const layerGroup = L.layerGroup();
                geojson.coordinates.forEach(function(polygonCoords) {
                    const latlngs = polygonCoords[0].map(function(coord) {
                        return [coord[1], coord[0]]; // [lat, lng]
                    });
                    layerGroup.addLayer(L.polygon(latlngs, options));
                });
                return layerGroup;
            }
            return null;
        }
        
        const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
        
        // Capa para puntos de contenedores
        const containerPointsLayer = L.layerGroup();  // se añadirá/retirará según visibilidad (gestionado por control de capas)
        let containerPointLayers = {};  // Mapa de pointId -> {polygon, iconMarker} para actualización en tiempo real
        let isContainerPointMode = false;
        const canManageContainers = {{ 'true' if current_user.is_authenticated and (current_user.has_role('admin') or current_user.has_role('section_responsible')) else 'false' }};
        const canSuggestContainers = {{ 'true' if current_user.is_authenticated else 'false' }};
        
        // Cargar y dibujar secciones
        const sectionsLayer = L.layerGroup();
        fetch('{{ url_for("inventory.api_sections") }}')
            .then(response => response.json())
            .then(sections => {
                sections.forEach(function(section) {
                    if (section.geometry) {
                        const polygon = geoJsonToLeaflet(section.geometry);
                        if (polygon) {
                            const color = getDistrictColor(section.district_code);
                            
                            // Si es un LayerGroup (MultiPolygon), aplicar estilo a cada capa
                            if (polygon instanceof L.LayerGroup) {
                                polygon.eachLayer(function(layer) {
                                    layer.setStyle({
                                        fillColor: color,
                                        fillOpacity: 0.35,  // Más color para identificar secciones
                                        color: color,  // Borde del color del distrito
                                        weight: 0.8,  // Borde fino
                                        opacity: 0.85  // Borde ligeramente visible
                                    });
                                    layer.bindPopup(`
                                        <div style="min-width: 150px;">
                                            <h6 class="fw-bold mb-1">${section.district_name}</h6>
                                            <p class="small mb-0">${section.name}</p>
                                            <p class="small text-muted mb-0">Código: ${section.full_code}</p>
                                        </div>
                                    `);
                                    // Interceptar clics en mode contenidors
                                    if (canManageContainers) {
                                        layer.on('click', function(e) {
                                            if (!isContainerPointMode) {
                                                return;
                                            }
                                            if (e.originalEvent && L.DomEvent) {
                                                L.DomEvent.stop(e.originalEvent);
                                            }
                                            this.closePopup();
                                            if (e.latlng) {
                                                handleContainerPointCreation(e.latlng);
                                            }
                                        });
                                    }
                                });
                            } else {
                                // Si es un Polygon simple
                                polygon.setStyle({
                                    fillColor: color,
                                    fillOpacity: 0.35,  // Más color para identificar secciones
                                    color: color,  // Borde del color del distrito
                                    weight: 0.8,  // Borde fino
                                    opacity: 0.85  // Borde ligeramente visible
                                });
                                
                                // Popup con información de la sección
                                polygon.bindPopup(`
                                    <div style="min-width: 150px;">
                                        <h6 class="fw-bold mb-1">${section.district_name}</h6>
                                        <p class="small mb-0">${section.name}</p>
                                        <p class="small text-muted mb-0">Código: ${section.full_code}</p>
                                    </div>
                                `);
                                
                                if (canManageContainers) {
                                    polygon.on('click', function(e) {
                                        if (!isContainerPointMode) {
                                            return;
                                        }
                                        if (e.originalEvent && L.DomEvent) {
                                            L.DomEvent.stop(e.originalEvent);
                                        }
                                        this.closePopup();
                                        if (e.latlng) {
                                            handleContainerPointCreation(e.latlng);
                                        }
                                    });
                                }
                            }
                            
                            sectionsLayer.addLayer(polygon);
                        }
                    }
                });
                
                // Añadir capa de secciones al mapa (el control de capas la gestionará)
                map.addLayer(sectionsLayer);
            })
            .catch(error => {
                console.error('Error loading sections:', error);
            });
        
        // Cargar y dibujar boundary de la ciudad
        const boundaryLayer = L.layerGroup();
        fetch('{{ url_for("inventory.api_boundary") }}')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Boundary data received:', data);
                if (data.error) {
                    console.error('Boundary API error:', data.error);
                    return;
                }
                if (data.geometry) {
                    const polygon = geoJsonToLeaflet(data.geometry);
                    if (polygon) {
                        // Si es un LayerGroup (MultiPolygon), aplicar estilo a cada capa
                        if (polygon instanceof L.LayerGroup) {
                            polygon.eachLayer(function(layer) {
                                layer.setStyle({
                                    fillColor: '#4A9B5C',  // Verde de Tarracograf
                                    fillOpacity: 0.0,      // Sin relleno
                                    color: '#4A9B5C',      // Borde verde
                                    weight: 1.5,           // Borde más fino
                                    opacity: 0.7,          // Borde menos opaco
                                    dashArray: '10, 5'     // Línea punteada para diferenciarlo
                                });
                                layer.bindPopup(`
                                    <div style="min-width: 150px;">
                                        <h6 class="fw-bold mb-1">${data.name || 'Tarragona'}</h6>
                                        <p class="small text-muted mb-0">Límite de la ciudad</p>
                                        ${data.calculated_at ? `<p class="small text-muted mb-0">Calculado: ${new Date(data.calculated_at).toLocaleDateString()}</p>` : ''}
                                    </div>
                                `);
                            });
                        } else {
                            // Si es un Polygon simple
                            polygon.setStyle({
                                fillColor: '#4A9B5C',  // Verde de Tarracograf
                                fillOpacity: 0.0,      // Sin relleno
                                color: '#4A9B5C',      // Borde verde
                                weight: 1.5,           // Borde más fino
                                opacity: 0.7,          // Borde menos opaco
                                dashArray: '10, 5'     // Línea punteada para diferenciarlo
                            });
                            
                            // Popup con información del boundary
                            polygon.bindPopup(`
                                <div style="min-width: 150px;">
                                    <h6 class="fw-bold mb-1">${data.name || 'Tarragona'}</h6>
                                    <p class="small text-muted mb-0">Límite de la ciudad</p>
                                    ${data.calculated_at ? `<p class="small text-muted mb-0">Calculado: ${new Date(data.calculated_at).toLocaleDateString()}</p>` : ''}
                                </div>
                            `);
                        }
                        
                        boundaryLayer.addLayer(polygon);
                        // Añadir capa de límites al mapa (el control de capas la gestionará)
                        map.addLayer(boundaryLayer);
                        console.log('Boundary added to map');
                        
                        // Establecer maxBounds para limitar el movimiento del mapa
                        if (data.bounds) {
                            const maxBounds = L.latLngBounds(
                                data.bounds.southwest,  // [lat, lng]
                                data.bounds.northeast   // [lat, lng]
                            );
                            map.setMaxBounds(maxBounds);
                            console.log('Map bounds restricted to:', maxBounds);
                        }
                    } else {
                        console.error('Failed to convert boundary geometry to Leaflet layer');
                    }
                } else {
                    console.error('No geometry in boundary data');
                }
            })
            .catch(error => {
                console.error('Error loading boundary:', error);
            });
        
        // Crear grupo de marcadores de inventario
        const markers = L.markerClusterGroup();
        
        // Definir capas base (solo OpenStreetMap por ahora, satelital se añadirá después)
        const baseLayers = {
            "{{ _('Mapa') }}": osmLayer
        };
        
        // Definir capas overlay
        const overlayLayers = {
            "{{ _('Items d\'inventari') }}": markers,
            "{{ _('Punts de contenidors') }}": containerPointsLayer,
            "{{ _('Seccions') }}": sectionsLayer,
            "{{ _('Límits de la ciutat') }}": boundaryLayer
        };
        
        // Añadir capas overlay al mapa por defecto (el control de capas las gestionará)
        map.addLayer(markers);
        map.addLayer(containerPointsLayer);
        map.addLayer(sectionsLayer);
        map.addLayer(boundaryLayer);
        
        // Añadir control de capas al mapa
        const layerControl = L.control.layers(baseLayers, overlayLayers, {
            position: 'topright',
            collapsed: true
        }).addTo(map);
        
        // Crear leyenda para puntos de contenedores
        const legend = L.control({ position: 'bottomright' });
        
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div style="background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); font-size: 12px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #333;">{{ _('Punts de contenidors') }}</div>
                    <div style="display: flex; align-items: center; margin-bottom: 6px;">
                        <div class="container-point-icon normal" style="width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ffffff; box-shadow: 0 0 4px rgba(0,0,0,0.4); background-color: #4A9B5C; margin-right: 8px;">
                            <i class="fas fa-dumpster"></i>
                        </div>
                        <span>{{ _('Normal') }}</span>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="container-point-icon overflow" style="width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ffffff; box-shadow: 0 0 4px rgba(0,0,0,0.4); background-color: #FF3B3B; margin-right: 8px;">
                            <i class="fas fa-dumpster"></i>
                        </div>
                        <span>{{ _('Desbordat') }}</span>
                    </div>
                </div>
            `;
            return div;
        };
        
        legend.addTo(map);
        
        // Category icons mapping (matches Python get_inventory_icon function)
        function getCategoryIconInfo(category, subcategory) {
            const iconMapping = {
                // Palomas
                'palomas_nido': { icon: 'fa-home', color: '#007bff' },
                'palomas_excremento': { icon: 'fa-biohazard', color: '#dc3545' },
                'palomas_plumas': { icon: 'fa-feather', color: '#17a2b8' },
                'palomas_': { icon: 'fa-dove', color: '#007bff' },
                'palomas_otro': { icon: 'fa-dove', color: '#007bff' },
                // Basura
                'basura_escombreries_desbordades': { icon: 'fa-trash-alt', color: '#ffc107' },
                'basura_vertidos': { icon: 'fa-tint', color: '#dc3545' },
                'basura_': { icon: 'fa-trash', color: '#6c757d' },
                'basura_otro': { icon: 'fa-trash', color: '#6c757d' }
            };
            
            let key = (category || '') + '_' + (subcategory || '');
            if (iconMapping[key]) {
                return iconMapping[key];
            }
            // Fallback to category only
            key = (category || '') + '_';
            if (iconMapping[key]) {
                return iconMapping[key];
            }
            // Default fallback
            return { icon: 'fa-circle', color: '#6c757d' };
        }
        
        // Helper function to get image path for a specific size
        // Removes any existing size suffix and adds the requested one
        function getImagePathForSize(imagePath, size) {
            if (!imagePath) return null;
            // If it's already a full URL (S3), return as-is
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            // Find the last dot (extension)
            const lastDot = imagePath.lastIndexOf('.');
            if (lastDot === -1) {
                // No extension found, return original
                return imagePath;
            }
            
            const ext = imagePath.substring(lastDot);
            const nameWithPossibleSuffix = imagePath.substring(0, lastDot);
            
            // Remove any existing size suffix (_thumbnail, _medium, _large)
            // Pattern: _thumbnail, _medium, or _large at the end
            const baseName = nameWithPossibleSuffix.replace(/_?(thumbnail|medium|large)$/i, '');
            
            // Add the requested size suffix
            return baseName + '_' + size + ext;
        }
        
        // Category icons with optional image
        function getCategoryIcon(category, subcategory, imagePath) {
            const colors = {
                'excremento': '#8B4513',
                'nido': '#D2691E',
                'plumas': '#708090',
                'brossa_desbordada': '#FF6B35',
                'vertidos': '#4ECDC4',
                'otro': '#696969'
            };
            
            const iconInfo = getCategoryIconInfo(category, subcategory);
            const color = colors[subcategory] || iconInfo.color || '#696969';
            
            const size = 40; // Size for custom markers
            const iconSize = [size, size];
            const iconAnchor = [size/2, size/2];
            
            // If image exists, use it as marker
            if (imagePath) {
                return L.divIcon({
                    className: 'custom-marker-image',
                    html: `<div style="width: ${size}px; 
                                      height: ${size}px; 
                                      border-radius: 50%; 
                                      border: 3px solid white;
                                      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
                                      overflow: hidden;
                                      background-color: ${color};
                                      display: flex;
                                      align-items: center;
                                      justify-content: center;">
                                <img src="${getImagePathForSize(imagePath, 'thumbnail')}" 
                                     style="width: 100%; 
                                            height: 100%; 
                                            object-fit: cover;
                                            border-radius: 50%;" 
                                     alt="${category}"
                                     onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\\'fas ${iconInfo.icon}\\' style=\\'color: white; font-size: 18px;\\'></i>';">
                            </div>`,
                    iconSize: iconSize,
                    iconAnchor: iconAnchor
                });
            }
            
            // Default icon with Font Awesome
            return L.divIcon({
                className: 'custom-marker',
                html: `<div style="background-color: ${color}; 
                                  width: ${size}px; 
                                  height: ${size}px; 
                                  border-radius: 50%; 
                                  border: 3px solid white;
                                  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                                  display: flex;
                                  align-items: center;
                                  justify-content: center;">
                                <i class="fas ${iconInfo.icon}" style="color: white; font-size: 18px;"></i>
                            </div>`,
                iconSize: iconSize,
                iconAnchor: iconAnchor
            });
        }
        
        // Función global para mostrar toasts personalizados
        window.showToast = function(title, message, type = 'info') {
            // Asegurarse de que Bootstrap esté disponible
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap no está disponible');
                // Fallback a alert si Bootstrap no está disponible
                alert(title ? `${title}: ${message}` : message);
                return;
            }
            
            const typeClasses = {
                'success': 'bg-success',
                'error': 'bg-danger',
                'warning': 'bg-warning text-dark',
                'info': 'bg-info'
            };
            
            // Crear o obtener contenedor de toasts
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            const toastDiv = document.createElement('div');
            toastDiv.className = `toast align-items-center text-white ${typeClasses[type] || typeClasses.info} border-0`;
            toastDiv.setAttribute('role', 'alert');
            toastDiv.setAttribute('aria-live', 'assertive');
            toastDiv.setAttribute('aria-atomic', 'true');
            toastDiv.style.minWidth = '300px';
            toastDiv.style.maxWidth = '400px';
            
            const iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            const displayText = title ? (message ? `${title}<br>${message}` : title) : message;
            
            toastDiv.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas ${iconMap[type] || iconMap.info} me-2"></i>
                        ${displayText}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            toastContainer.appendChild(toastDiv);
            
            // Inicializar y mostrar el toast
            const toast = new bootstrap.Toast(toastDiv, { 
                delay: type === 'error' ? 5000 : 3000,
                autohide: true
            });
            
            // Asegurarse de que el toast se muestre
            toastDiv.addEventListener('shown.bs.toast', function() {
                console.log('Toast mostrado correctamente');
            });
            
            toast.show();
            
            // Limpiar el toast del DOM cuando se oculte
            toastDiv.addEventListener('hidden.bs.toast', function() {
                toastDiv.remove();
                // Si el contenedor está vacío, mantenerlo para futuros toasts
            });
        };
        
        // Función auxiliar para mostrar alertas (wrapper para compatibilidad)
        window.showAlert = function(message, type = 'info') {
            console.log('showAlert called:', message, type);
            window.showToast('', message, type);
        };
        
        // Función global para mostrar confirmaciones personalizadas (reemplaza confirm() nativo)
        window.showConfirm = function(message, title = '{{ _("Confirmar") }}') {
            return new Promise((resolve) => {
                // Asegurarse de que Bootstrap esté disponible
                if (typeof bootstrap === 'undefined') {
                    // Fallback a confirm nativo si Bootstrap no está disponible
                    resolve(confirm(message));
                    return;
                }
                
                // Crear modal de confirmación
                const modalDiv = document.createElement('div');
                modalDiv.className = 'modal fade';
                modalDiv.id = 'customConfirmModal';
                modalDiv.setAttribute('tabindex', '-1');
                modalDiv.setAttribute('aria-labelledby', 'customConfirmModalLabel');
                modalDiv.setAttribute('aria-hidden', 'true');
                
                modalDiv.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="customConfirmModalLabel">
                                    <i class="fas fa-question-circle me-2 text-primary"></i>${title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p class="mb-0">${message}</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmCancelBtn">
                                    <i class="fas fa-times me-1"></i>{{ _("Cancel·lar") }}
                                </button>
                                <button type="button" class="btn btn-primary" id="confirmOkBtn">
                                    <i class="fas fa-check me-1"></i>{{ _("Confirmar") }}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalDiv);
                
                const modal = new bootstrap.Modal(modalDiv);
                
                // Manejar confirmación
                document.getElementById('confirmOkBtn').addEventListener('click', function() {
                    modal.hide();
                    resolve(true);
                });
                
                // Manejar cancelación
                const cancelBtn = document.getElementById('confirmCancelBtn');
                cancelBtn.addEventListener('click', function() {
                    modal.hide();
                    resolve(false);
                });
                
                // Limpiar cuando se cierre el modal
                modalDiv.addEventListener('hidden.bs.modal', function() {
                    modalDiv.remove();
                });
                
                // Mostrar modal
                modal.show();
            });
        };
        
        // Función auxiliar para sugerir un punt de contenidors (usuarios normales)
        async function handleContainerPointSuggestion(latlng) {
            if (!canSuggestContainers) return;
            
            const lat = latlng.lat;
            const lng = latlng.lng;
            
            const confirmed = await window.showConfirm(
                '{{ _("Vols indicar que aquí hi ha contenidors? Un administrador o responsable revisarà la teva suggerència.") }}',
                '{{ _("Suggerir punt de contenidors") }}'
            );
            
            if (!confirmed) {
                return;
            }
            
            fetch('{{ url_for("inventory.suggest_container_point") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }
                if (data.message) {
                    showAlert(data.message, 'success');
                }
            })
            .catch(err => {
                console.error('Error suggesting container point:', err);
                showAlert('{{ _("Error suggerint el punt de contenidors") }}', 'error');
            });
        }
        
        // Función auxiliar para crear un punt de contenidors desde una lat/lng (admin/responsables)
        async function handleContainerPointCreation(latlng, skipModeCheck) {
            // skipModeCheck permite crear desde geolocalización sin activar el modo
            if (!skipModeCheck && (!isContainerPointMode || !canManageContainers)) return;
            if (!canManageContainers) return;
            
            const lat = latlng.lat;
            const lng = latlng.lng;
            
            const confirmed = await window.showConfirm(
                '{{ _("Crear un punt de contenidors en aquesta ubicació?") }}',
                '{{ _("Crear punt de contenidors") }}'
            );
            
            if (!confirmed) {
                return;
            }
            
            fetch('{{ url_for("inventory.create_container_point") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lng,
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'error');
                    return;
                }
                // Recargar puntos
                loadContainerPoints();
                showAlert('{{ _("Punt de contenidors creat correctament") }}', 'success');
            })
            .catch(err => {
                console.error('Error creating container point:', err);
                showAlert('{{ _("Error creant el punt de contenidors") }}', 'error');
            });
        }
        
        // Función para cargar puntos de contenedores
        function loadContainerPoints() {
            fetch('{{ url_for("inventory.api_container_points") }}')
                .then(response => response.json())
                .then(points => {
                    containerPointsLayer.clearLayers();
                    containerPointLayers = {};  // Limpiar referencias anteriores
                    
                    points.forEach(function(point) {
                        if (!point.geometry) {
                            return;
                        }
                        const polygon = geoJsonToLeaflet(point.geometry, { pane: 'containerPane' });
                        if (!polygon) {
                            return;
                        }
                        
                        const isOverflow = point.status === 'overflow';
                        
                        function styleOverflowLayer(layer) {
                            layer.setStyle({
                                fillColor: isOverflow ? '#FF3B3B' : '#4A9B5C',
                                fillOpacity: isOverflow ? 0.7 : 0.15,
                                color: isOverflow ? '#FF3B3B' : '#4A9B5C',
                                weight: isOverflow ? 4 : 2,
                                opacity: 1,
                            });
                        }
                        
                        // Aplicar estilo según sea Polygon o LayerGroup
                        if (polygon instanceof L.LayerGroup) {
                            polygon.eachLayer(styleOverflowLayer);
                        } else {
                            styleOverflowLayer(polygon);
                        }
                        
                        // Animación parpadeante para desbordados (más agressiva)
                        if (isOverflow) {
                            const blinkLayers = [];
                            if (polygon instanceof L.LayerGroup) {
                                polygon.eachLayer(function(layer) {
                                    blinkLayers.push(layer);
                                });
                            } else {
                                blinkLayers.push(polygon);
                            }
                            
                            blinkLayers.forEach(function(layer) {
                                let on = true;
                                const interval = setInterval(function() {
                                    on = !on;
                                    if (on) {
                                        layer.setStyle({
                                            fillOpacity: 0.85,
                                            weight: 5,
                                            color: '#FF0000'
                                        });
                                    } else {
                                        layer.setStyle({
                                            fillOpacity: 0.05,
                                            weight: 1,
                                            color: '#FFB3B3'
                                        });
                                    }
                                }, 350); // parpadeo rápido para que se note incluso con zoom out
                                layer._containerBlinkInterval = interval;
                                layer.on('remove', function() {
                                    if (this._containerBlinkInterval) {
                                        clearInterval(this._containerBlinkInterval);
                                    }
                                });
                            });
                        }
                        
                        // Popup con controles (solo lectura o gestión según permisos)
                        const statusLabel = isOverflow ? '{{ _("Desbordat") }}' : '{{ _("Normal") }}';
                        const coordsText = point.address 
                            ? point.address 
                            : `(${point.latitude.toFixed(5)}, ${point.longitude.toFixed(5)})`;
                        let actionsHtml = '';
                        if (canManageContainers) {
                            actionsHtml = `
                                <div class="mt-2 d-flex gap-1">
                                    <button class="btn btn-sm ${isOverflow ? 'btn-success' : 'btn-warning'} flex-fill" onclick="window.toggleContainerStatus(${point.id}, '${isOverflow ? 'normal' : 'overflow'}')">
                                        ${isOverflow ? '{{ _("Marcar com a normal") }}' : '{{ _("Marcar com desbordat") }}'}
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="window.deleteContainerPoint(${point.id})">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            `;
                        } else if (isAuthenticated && !isOverflow) {
                            // Usuari normal, punt en estat NORMAL -> pot reportar que està desbordat
                            actionsHtml = `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-warning w-100" onclick="window.reportContainerOverflow(${point.id}, this)">
                                        {{ _('Estan desbordats') }}
                                    </button>
                                </div>
                            `;
                        } else if (isAuthenticated && isOverflow) {
                            // Usuari normal, punt ja està marcat com desbordat
                            actionsHtml = `
                                <div class="mt-2">
                                    <small class="text-muted">{{ _('Aquest punt ja està marcat com desbordat') }}</small>
                                </div>
                            `;
                        } else {
                            actionsHtml = `
                                <div class="mt-2">
                                    <small class="text-muted">{{ _('Inicia sessió per reportar que està desbordat') }}</small>
                                </div>
                            `;
                        }
                        
                        const popupHtml = `
                            <div style="min-width: 160px;">
                                <h6 class="fw-bold mb-1">{{ _('Punt de contenidors') }}</h6>
                                <p class="small mb-1">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    ${coordsText}
                                </p>
                                <p class="small mb-1">
                                    <span class="badge ${isOverflow ? 'bg-danger' : 'bg-success'}">${statusLabel}</span>
                                </p>
                                ${point.last_overflow_report ? `
                                    <p class="small text-muted mb-1">{{ _('Darrer report de desbordament') }}:<br>${new Date(point.last_overflow_report).toLocaleString()}</p>
                                ` : ''}
                                ${point.notes ? `<p class="small mb-1">${point.notes}</p>` : ''}
                                ${actionsHtml}
                            </div>
                        `;
                        
                        // Añadir polígono (zona clicable)
                        if (polygon instanceof L.LayerGroup) {
                            polygon.eachLayer(function(layer) {
                                layer.bindPopup(popupHtml);
                                containerPointsLayer.addLayer(layer);
                            });
                        } else {
                            polygon.bindPopup(popupHtml);
                            containerPointsLayer.addLayer(polygon);
                        }

                        // Añadir icono de contenedor en el centre del punt
                        const iconHtml = `
                            <div class="container-point-icon ${isOverflow ? 'overflow' : 'normal'}">
                                <i class="fas fa-dumpster"></i>
                            </div>
                        `;
                        const icon = L.divIcon({
                            className: 'container-point-icon-wrapper',
                            html: iconHtml,
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        });
                        const iconMarker = L.marker([point.latitude, point.longitude], {
                            icon: icon,
                            pane: 'containerPane',
                            interactive: false
                        });
                        containerPointsLayer.addLayer(iconMarker);
                        
                        // Guardar referencias para actualización en tiempo real
                        containerPointLayers[point.id] = {
                            polygon: polygon,
                            iconMarker: iconMarker,
                            point: point
                        };
                    });
                    
                    // La visibilidad de la capa se gestiona mediante el control de capas
                    // Si la capa está activa en el control, los puntos se verán automáticamente
                })
                .catch(error => {
                    console.error('Error loading container points:', error);
                });
        }
        
        // Función para actualizar un punto específico en tiempo real
        function updateContainerPoint(pointId, updatedPoint) {
            const layers = containerPointLayers[pointId];
            if (!layers) {
                // Si no tenemos referencias, recargar todos los puntos
                loadContainerPoints();
                return;
            }
            
            const isOverflow = updatedPoint.status === 'overflow';
            
            // Actualizar estilo del polígono
            function styleOverflowLayer(layer) {
                layer.setStyle({
                    fillColor: isOverflow ? '#FF3B3B' : '#4A9B5C',
                    fillOpacity: isOverflow ? 0.7 : 0.15,
                    color: isOverflow ? '#FF3B3B' : '#4A9B5C',
                    weight: isOverflow ? 4 : 2,
                    opacity: 1,
                });
            }
            
            if (layers.polygon instanceof L.LayerGroup) {
                layers.polygon.eachLayer(styleOverflowLayer);
            } else {
                styleOverflowLayer(layers.polygon);
            }
            
            // Actualizar animación de parpadeo
            if (layers.polygon instanceof L.LayerGroup) {
                layers.polygon.eachLayer(function(layer) {
                    if (layer._containerBlinkInterval) {
                        clearInterval(layer._containerBlinkInterval);
                        layer._containerBlinkInterval = null;
                    }
                });
            } else if (layers.polygon._containerBlinkInterval) {
                clearInterval(layers.polygon._containerBlinkInterval);
                layers.polygon._containerBlinkInterval = null;
            }
            
            if (isOverflow) {
                const blinkLayers = [];
                if (layers.polygon instanceof L.LayerGroup) {
                    layers.polygon.eachLayer(function(layer) {
                        blinkLayers.push(layer);
                    });
                } else {
                    blinkLayers.push(layers.polygon);
                }
                
                blinkLayers.forEach(function(layer) {
                    let on = true;
                    const interval = setInterval(function() {
                        on = !on;
                        if (on) {
                            layer.setStyle({
                                fillOpacity: 0.85,
                                weight: 5,
                                color: '#FF0000'
                            });
                        } else {
                            layer.setStyle({
                                fillOpacity: 0.05,
                                weight: 1,
                                color: '#FFB3B3'
                            });
                        }
                    }, 350);
                    layer._containerBlinkInterval = interval;
                });
            }
            
            // Actualizar icono
            const iconHtml = `
                <div class="container-point-icon ${isOverflow ? 'overflow' : 'normal'}">
                    <i class="fas fa-dumpster"></i>
                </div>
            `;
            const newIcon = L.divIcon({
                className: 'container-point-icon-wrapper',
                html: iconHtml,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            layers.iconMarker.setIcon(newIcon);
            
            // Actualizar popup
            const statusLabel = isOverflow ? '{{ _("Desbordat") }}' : '{{ _("Normal") }}';
            const coordsText = updatedPoint.address 
                ? updatedPoint.address 
                : `(${updatedPoint.latitude.toFixed(5)}, ${updatedPoint.longitude.toFixed(5)})`;
            let actionsHtml = '';
            if (canManageContainers) {
                actionsHtml = `
                    <div class="mt-2 d-flex gap-1">
                        <button class="btn btn-sm ${isOverflow ? 'btn-success' : 'btn-warning'} flex-fill" onclick="window.toggleContainerStatus(${pointId}, '${isOverflow ? 'normal' : 'overflow'}')">
                            ${isOverflow ? '{{ _("Marcar com a normal") }}' : '{{ _("Marcar com desbordat") }}'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="window.deleteContainerPoint(${pointId})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            } else if (isAuthenticated && isOverflow) {
                actionsHtml = `
                    <div class="mt-2">
                        <small class="text-muted">{{ _('Aquest punt ja està marcat com desbordat') }}</small>
                    </div>
                `;
            } else {
                actionsHtml = `
                    <div class="mt-2">
                        <small class="text-muted">{{ _('Inicia sessió per reportar que està desbordat') }}</small>
                    </div>
                `;
            }
            
            const popupHtml = `
                <div style="min-width: 160px;">
                    <h6 class="fw-bold mb-1">{{ _('Punt de contenidors') }}</h6>
                    <p class="small mb-1">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        ${coordsText}
                    </p>
                    <p class="small mb-1">
                        <span class="badge ${isOverflow ? 'bg-danger' : 'bg-success'}">${statusLabel}</span>
                    </p>
                    ${updatedPoint.last_overflow_report ? `
                        <p class="small text-muted mb-1">{{ _('Darrer report de desbordament') }}:<br>${new Date(updatedPoint.last_overflow_report).toLocaleString()}</p>
                    ` : ''}
                    ${updatedPoint.notes ? `<p class="small mb-1">${updatedPoint.notes}</p>` : ''}
                    ${actionsHtml}
                </div>
            `;
            
            if (layers.polygon instanceof L.LayerGroup) {
                layers.polygon.eachLayer(function(layer) {
                    layer.setPopupContent(popupHtml);
                });
            } else {
                layers.polygon.setPopupContent(popupHtml);
            }
            
            // Actualizar referencia del punto
            layers.point = updatedPoint;
        }
        
        // Funciones accesibles desde popup (window.*)
        window.reportContainerOverflow = async function(pointId, button) {
            const confirmed = await window.showConfirm(
                '{{ _("Confirmes que aquest punt de contenidors està desbordat?") }}',
                '{{ _("Reportar desbordament") }}'
            );
            
            if (!confirmed) {
                return;
            }
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Enviant...") }}';
            }
            fetch(`{{ url_for('inventory.report_container_point_overflow', point_id=0) }}`.replace('0', pointId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({}),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showAlert(data.error, 'error');
                    if (button) {
                        button.disabled = false;
                        button.innerHTML = '{{ _("Estan desbordats") }}';
                    }
                    return;
                }
                
                // Obtener datos actualizados del punto desde el backend
                fetch('{{ url_for("inventory.api_container_points") }}')
                    .then(response => response.json())
                    .then(points => {
                        const updatedPoint = points.find(p => p.id === pointId);
                        if (updatedPoint) {
                            // Actualizar solo este punto en tiempo real
                            updateContainerPoint(pointId, updatedPoint);
                        } else {
                            // Si no encontramos el punto, recargar todos
                            loadContainerPoints();
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching updated point:', err);
                        // Fallback: recargar todos los puntos
                        loadContainerPoints();
                    });
                
                if (button) {
                    button.disabled = true;
                    button.innerHTML = '{{ _("Gràcies!") }}';
                }
            })
            .catch(err => {
                console.error('Error reporting container overflow:', err);
                showAlert('{{ _("Error en registrar el report. Intenta-ho de nou més tard.") }}', 'error');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = '{{ _("Estan desbordats") }}';
                }
            });
        };
        
        if (canManageContainers) {
            window.toggleContainerStatus = function(pointId, newStatus) {
                fetch(`{{ url_for('inventory.update_container_point_status', point_id=0) }}`.replace('0', pointId), {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showAlert(data.error, 'error');
                    } else {
                        showAlert('{{ _("Estat del punt actualitzat correctament") }}', 'success');
                    }
                    loadContainerPoints();
                })
                .catch(err => {
                    console.error('Error updating container point status:', err);
                    showAlert('{{ _("Error actualitzant l\'estat del punt de contenidors") }}', 'error');
                });
            };
            
            window.deleteContainerPoint = async function(pointId) {
                const confirmed = await window.showConfirm(
                    '{{ _("Vols eliminar aquest punt de contenidors?") }}',
                    '{{ _("Eliminar punt de contenidors") }}'
                );
                
                if (!confirmed) {
                    return;
                }
                fetch(`{{ url_for('inventory.delete_container_point', point_id=0) }}`.replace('0', pointId), {
                    method: 'DELETE',
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Error eliminant el punt de contenidors');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        showAlert('{{ _("Punt de contenidors eliminat correctament") }}', 'success');
                        loadContainerPoints();
                    } else if (data.error) {
                        showAlert(data.error, 'error');
                    }
                })
                .catch(err => {
                    console.error('Error deleting container point:', err);
                    showAlert(err.message || '{{ _("Error eliminant el punt de contenidors") }}', 'error');
                });
            };
        }
        
        // Cargar puntos de contenedores al iniciar
        loadContainerPoints();
        
        // Si estamos en mode contenidors y clicamos sobre un punt existent,
        // queremos veure el popup, NO crear un nou punt.
        if (canManageContainers) {
            containerPointsLayer.on('click', function(e) {
                if (!isContainerPointMode) {
                    return; // comportament normal: obrir popup
                }
                // Evitar que el clic arribi al handler global del mapa
                if (e.originalEvent && L.DomEvent) {
                    L.DomEvent.stop(e.originalEvent);
                }
                // Deixem que Leaflet gestioni el popup del layer
            });
        }
        
        // Modo creación de puntos de contenedores (solo admin / responsables)
        if (canManageContainers) {
            const toggleModeBtn = document.getElementById('toggle-container-mode');
            const createFromLocationBtn = document.getElementById('create-container-from-location');
            
            // Variable para almacenar el handler del click del mapa
            let mapClickHandler = null;
            
            if (toggleModeBtn) {
                toggleModeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    isContainerPointMode = !isContainerPointMode;
                    if (isContainerPointMode) {
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                        this.innerHTML = '<i class="fas fa-mouse-pointer me-1"></i>{{ _("Fes clic al mapa per afegir un punt") }}';
                        map.getContainer().style.cursor = 'crosshair';
                        // En mode contenidors, els cercles han de poder rebre clics
                        containerPane.style.pointerEvents = 'auto';
                        
                        // Añadir handler del click del mapa solo cuando el modo está activo
                        if (!mapClickHandler) {
                            mapClickHandler = function(e) {
                                if (e.latlng && isContainerPointMode) {
                                    handleContainerPointCreation(e.latlng);
                                }
                            };
                            map.on('click', mapClickHandler);
                        }
                    } else {
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                        this.innerHTML = '<i class="fas fa-trash-alt me-1"></i>{{ _("Mode punts de contenidors") }}';
                        map.getContainer().style.cursor = '';
                        // Fora de mode contenidors, deixem passar els clics als markers d'inventari
                        containerPane.style.pointerEvents = 'none';
                        
                        // Remover handler del click del mapa cuando se desactiva el modo
                        if (mapClickHandler) {
                            map.off('click', mapClickHandler);
                            mapClickHandler = null;
                        }
                    }
                });
            }
            
            if (createFromLocationBtn) {
                createFromLocationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (!navigator.geolocation) {
                        showAlert('{{ _("La geolocalización no está disponible en tu navegador.") }}', 'warning');
                        return;
                    }
                    
                    // Guardar referencia al botón y texto original
                    const btn = createFromLocationBtn;
                    const originalHTML = btn.innerHTML;
                    const originalDisabled = btn.disabled;
                    
                    // Mostrar indicador de carga inmediatamente
                    btn.disabled = true;
                    const loadingHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Obtenint ubicació...") }}';
                    btn.innerHTML = loadingHTML;
                    
                    // Forzar actualización del DOM
                    btn.offsetHeight; // Trigger reflow
                    
                    // Función para restaurar el botón
                    function restoreButton() {
                        setTimeout(function() {
                            btn.disabled = originalDisabled;
                            btn.innerHTML = originalHTML;
                        }, 100);
                    }
                    
                    // Función para manejar errores con mensajes más específicos
                    function handleGeolocationError(error) {
                        console.error('Geolocation error:', error);
                        let errorMessage = '{{ _("No s\'ha pogut obtenir la teva ubicació.") }}';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '{{ _("Permís de geolocalització denegat. Si us plau, activa la geolocalització a la configuració del teu navegador.") }}';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '{{ _("La ubicació no està disponible. Assegura\'t que el GPS estigui activat i intenta-ho de nou.") }}';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '{{ _("Temps d\'espera esgotat. Si us plau, intenta-ho de nou.") }}';
                                break;
                            default:
                                errorMessage = '{{ _("Error desconegut obtenint la ubicació. Si us plau, utilitza el mode de clic al mapa.") }}';
                                break;
                        }
                        
                        showAlert(errorMessage, 'error');
                        restoreButton();
                    }
                    
                    // Intentar primero con configuración más permisiva
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            console.log('Location obtained:', lat, lng);
                            
                            // Validar que esté en el área de Tarragona (aproximado)
                            if (lat >= 40.5 && lat <= 41.5 && lng >= 0.5 && lng <= 2.0) {
                                // Crear punto de contenedor en la ubicación actual
                                // skipModeCheck = true porque viene de geolocalización, no del modo de clic
                                const latlng = L.latLng(lat, lng);
                                if (canManageContainers) {
                                    handleContainerPointCreation(latlng, true);
                                } else if (canSuggestContainers) {
                                    handleContainerPointSuggestion(latlng);
                                }
                                
                                // Restaurar botón
                                restoreButton();
                                
                                // Centrar mapa en la ubicación
                                map.setView([lat, lng], 18);
                            } else {
                                showAlert('{{ _("La teva ubicació està fora de l\'àrea de Tarragona. Si us plau, utilitza el mode de clic al mapa.") }}', 'warning');
                                restoreButton();
                            }
                        },
                        function(error) {
                            console.error('First geolocation attempt failed:', error);
                            // Si falla, intentar con configuración alternativa
                            console.log('Retrying geolocation with different settings...');
                            
                            // Actualizar el mensaje del botón
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Tornant a intentar...") }}';
                            btn.offsetHeight; // Trigger reflow
                            
                            navigator.geolocation.getCurrentPosition(
                                function(position) {
                                    const lat = position.coords.latitude;
                                    const lng = position.coords.longitude;
                                    
                                    console.log('Location obtained on retry:', lat, lng);
                                    
                                        if (lat >= 40.5 && lat <= 41.5 && lng >= 0.5 && lng <= 2.0) {
                                            const latlng = L.latLng(lat, lng);
                                            if (canManageContainers) {
                                                // Admin/responsable: crear directamente
                                                handleContainerPointCreation(latlng, true);
                                            } else if (canSuggestContainers) {
                                                // Usuario normal: sugerir
                                                handleContainerPointSuggestion(latlng);
                                            }
                                            restoreButton();
                                            map.setView([lat, lng], 18);
                                        } else {
                                            showAlert('{{ _("La teva ubicació està fora de l\'àrea de Tarragona. Si us plau, utilitza el mode de clic al mapa.") }}', 'warning');
                                            restoreButton();
                                        }
                                },
                                handleGeolocationError,
                                {
                                    enableHighAccuracy: false,
                                    timeout: 15000,
                                    maximumAge: 60000  // Aceptar ubicación de hasta 1 minuto
                                }
                            );
                        },
                        {
                            enableHighAccuracy: false,  // Empezar sin alta precisión para localhost
                            timeout: 15000,
                            maximumAge: 60000  // Aceptar ubicación de hasta 1 minuto
                        }
                    );
                });
            }
            
        }
        
        // Botón para sugerir puntos desde ubicación (usuarios normales)
        if (canSuggestContainers && !canManageContainers) {
            const suggestFromLocationBtn = document.getElementById('suggest-container-from-location');
            
            if (suggestFromLocationBtn) {
                suggestFromLocationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (!navigator.geolocation) {
                        showAlert('{{ _("La geolocalización no está disponible en tu navegador.") }}', 'warning');
                        return;
                    }
                    
                    // Guardar referencia al botón y texto original
                    const btn = suggestFromLocationBtn;
                    const originalHTML = btn.innerHTML;
                    const originalDisabled = btn.disabled;
                    
                    // Mostrar indicador de carga inmediatamente
                    btn.disabled = true;
                    const loadingHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Obtenint ubicació...") }}';
                    btn.innerHTML = loadingHTML;
                    btn.offsetHeight; // Trigger reflow
                    
                    // Función para restaurar el botón
                    function restoreButton() {
                        setTimeout(function() {
                            btn.disabled = originalDisabled;
                            btn.innerHTML = originalHTML;
                        }, 100);
                    }
                    
                    // Función para manejar errores
                    function handleGeolocationError(error) {
                        console.error('Geolocation error:', error);
                        let errorMessage = '{{ _("No s\'ha pogut obtenir la teva ubicació.") }}';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = '{{ _("Permís de geolocalització denegat. Si us plau, activa la geolocalització a la configuració del teu navegador.") }}';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = '{{ _("La ubicació no està disponible. Assegura\'t que el GPS estigui activat i intenta-ho de nou.") }}';
                                break;
                            case error.TIMEOUT:
                                errorMessage = '{{ _("Temps d\'espera esgotat. Si us plau, intenta-ho de nou.") }}';
                                break;
                        }
                        
                        showAlert(errorMessage, 'error');
                        restoreButton();
                    }
                    
                    // Intentar obtener ubicación
                    navigator.geolocation.getCurrentPosition(
                        function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            console.log('Location obtained:', lat, lng);
                            
                            if (lat >= 40.5 && lat <= 41.5 && lng >= 0.5 && lng <= 2.0) {
                                const latlng = L.latLng(lat, lng);
                                handleContainerPointSuggestion(latlng);
                                restoreButton();
                                map.setView([lat, lng], 18);
                            } else {
                                showAlert('{{ _("La teva ubicació està fora de l\'àrea de Tarragona.") }}', 'warning');
                                restoreButton();
                            }
                        },
                        function(error) {
                            console.error('First geolocation attempt failed:', error);
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Tornant a intentar...") }}';
                            btn.offsetHeight;
                            
                            navigator.geolocation.getCurrentPosition(
                                function(position) {
                                    const lat = position.coords.latitude;
                                    const lng = position.coords.longitude;
                                    
                                    console.log('Location obtained on retry:', lat, lng);
                                    
                                    if (lat >= 40.5 && lat <= 41.5 && lng >= 0.5 && lng <= 2.0) {
                                        const latlng = L.latLng(lat, lng);
                                        handleContainerPointSuggestion(latlng);
                                        restoreButton();
                                        map.setView([lat, lng], 18);
                                    } else {
                                        showAlert('{{ _("La teva ubicació està fora de l\'àrea de Tarragona.") }}', 'warning');
                                        restoreButton();
                                    }
                                },
                                handleGeolocationError,
                                {
                                    enableHighAccuracy: false,
                                    timeout: 15000,
                                    maximumAge: 60000
                                }
                            );
                        },
                        {
                            enableHighAccuracy: false,
                            timeout: 15000,
                            maximumAge: 60000
                        }
                    );
                });
            }
        }
        
        // Load items from API (usar valores de URL en catalán)
        const category = '{{ selected_category or "" }}';
        const subcategory = '{{ selected_subcategory or "" }}';
        const params = [];
        if (category) params.push(`category=${category}`);
        if (subcategory) params.push(`subcategory=${subcategory}`);
        const apiUrl = params.length > 0 ? 
            `{{ url_for('inventory.api_items') }}?${params.join('&')}` : 
            '{{ url_for('inventory.api_items') }}';
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(items => {
                items.forEach(function(item) {
                    let voteButton = '';
                    let resolveButton = '';
                    const isAuthenticated = {{ 'true' if current_user.is_authenticated else 'false' }};
                    const imageThumb = item.image_url_thumbnail || item.image_url || null;
                    const imageMedium = item.image_url || null;
                    
                    if (isAuthenticated) {
                        // Vote button (Encara hi és) - solo icono
                        if (item.has_voted) {
                            voteButton = `
                                <button class="btn btn-sm btn-primary vote-btn" disabled style="padding: 0.25rem 0.5rem;" title="+1">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `;
                        } else {
                            voteButton = `
                                <button class="btn btn-sm btn-primary vote-btn" data-item-id="${item.id}" style="padding: 0.25rem 0.5rem;" title="+1">
                                    <i class="fas fa-plus"></i>
                                </button>
                            `;
                        }
                        
                        // Resolve button (Ya no está) - solo icono
                        resolveButton = `
                            <button class="btn btn-sm ${item.has_resolved ? 'btn-warning' : 'btn-warning'} resolve-btn rounded-pill" ${item.has_resolved ? 'disabled' : ''} ${item.has_resolved ? '' : `data-item-id="${item.id}"`} style="padding: 0.25rem 0.5rem;" title="{{ _('Ja no hi és') }}">
                                <i class="fas fa-times-circle"></i>
                            </button>
                        `;
                    }
                    
                    const iconInfo = getCategoryIconInfo(item.category, item.subcategory);
                    // Detect mobile screen size
                    const isMobile = window.innerWidth <= 768;
                    const popupMinWidth = isMobile ? '150px' : '180px';
                    
                    // Truncate address to max 25 characters
                    const truncatedAddress = item.address ? (item.address.length > 25 ? item.address.substring(0, 25) + '...' : item.address) : '';
                    
                    const popupContent = `
                        <div style="min-width: ${popupMinWidth}; max-width: ${isMobile ? '200px' : '220px'};">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas ${iconInfo.icon} ${iconInfo.color ? 'text-primary' : ''} me-1" style="font-size: 0.85rem;"></i>
                                <h6 class="fw-bold mb-0" style="font-size: ${isMobile ? '0.75rem' : '0.8rem'}; line-height: 1.2;">${item.full_category}</h6>
                            </div>
                            ${truncatedAddress ? `<p class="small text-muted mb-1" style="font-size: ${isMobile ? '0.65rem' : '0.7rem'}; line-height: 1.2;"><i class="fas fa-map-marker-alt" style="font-size: 0.6rem;"></i> ${truncatedAddress}</p>` : ''}
                            ${imageThumb ? `<img src="${imageThumb}" style="width: 100%; max-height: 70px; border-radius: 6px; margin: 0.25rem 0; object-fit: cover;" />` : ''}
                            <div class="d-flex justify-content-between align-items-center mt-1 pt-1 border-top" style="padding-top: 0.25rem !important; margin-top: 0.25rem !important; font-size: ${isMobile ? '0.65rem' : '0.7rem'} !important;">
                                <span class="text-muted">
                                    <i class="fas fa-star text-warning" style="font-size: 0.65rem;"></i>
                                    <strong>${item.importance_count || 0}</strong>
                                </span>
                                ${item.resolved_count > 0 ? `<span class="text-warning"><i class="fas fa-times-circle" style="font-size: 0.65rem;"></i> <strong>${item.resolved_count}</strong></span>` : ''}
                                ${item.share_count > 0 ? `<span class="text-info"><i class="fas fa-share-alt" style="font-size: 0.65rem;"></i> <strong>${item.share_count || 0}</strong></span>` : ''}
                                <div class="d-flex gap-1 align-items-center">
                                    <a href="/inventory/${item.id}" class="text-primary" style="font-size: 0.7rem;" title="{{ _('Veure detalls') }}">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="/inventory/${item.id}" class="text-info share-btn" data-url="${window.location.origin}/inventory/${item.id}" data-title="${item.full_category}" data-item-id="${item.id}" style="font-size: 0.7rem; cursor: pointer;" title="{{ _('Compartir') }}">
                                        <i class="fas fa-share-alt"></i>
                                    </a>
                                </div>
                            </div>
                            ${voteButton || resolveButton ? `
                                <div class="mt-1 pt-1 border-top d-flex gap-1 justify-content-center" style="padding-top: 0.25rem !important; margin-top: 0.25rem !important;">
                                    ${voteButton || ''}
                                    ${resolveButton || ''}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    const marker = L.marker([item.latitude, item.longitude], {
                        icon: getCategoryIcon(item.category, item.subcategory, imageThumb)
                    });
                    
                    marker.bindPopup(popupContent, { autoClose: true, closeOnClick: false });
                    markers.addLayer(marker);
                });
                
                // Añadir capa de items al mapa (el control de capas la gestionará)
                map.addLayer(markers);
                
                // Fit map to show all markers
                if (items.length > 0) {
                    const group = new L.featureGroup(markers.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                // Handle vote and resolve button clicks
                map.on('popupopen', function(e) {
                    const popup = e.popup;
                    const content = popup.getContent();
                    
                    // Re-bind vote buttons after popup opens
                    setTimeout(function() {
                        document.querySelectorAll('.vote-btn').forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemId = this.getAttribute('data-item-id');
                                voteForItem(itemId, this);
                            });
                        });
                        
                        // Re-bind resolve buttons after popup opens
                        document.querySelectorAll('.resolve-btn').forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const itemId = this.getAttribute('data-item-id');
                                resolveItem(itemId, this);
                            });
                        });
                        
                        // Re-bind share buttons after popup opens
                        document.querySelectorAll('.share-btn').forEach(function(btn) {
                            btn.addEventListener('click', function(e) {
                                e.preventDefault();
                                e.stopPropagation();
                                const url = this.getAttribute('data-url');
                                const title = this.getAttribute('data-title');
                                const itemId = this.getAttribute('data-item-id');
                                shareItem(url, title, itemId);
                            });
                        });
                    }, 100);
                });
            })
            .catch(error => {
                console.error('Error loading inventory items:', error);
            });
        
        // Vote function
        function voteForItem(itemId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Processant...") }}';
            
            // Get CSRF token from meta tag or form
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                           document.querySelector('input[name="csrf_token"]')?.value || 
                           '{{ csrf_token() }}';
            
            fetch(`{{ url_for('inventory.vote_item', item_id=0) }}`.replace('0', itemId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${encodeURIComponent(csrfToken)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update vote button - keep it active but disabled
                    button.disabled = true;
                    // Keep btn-primary class to show it's selected
                    button.innerHTML = '+1';
                    
                    // Update importance count in popup
                    const popupContent = button.closest('.leaflet-popup-content');
                    let countElement = popupContent.querySelector('.d-flex .small strong');
                    if (!countElement) {
                        // Try finding it in the stats section
                        const statsSection = button.closest('.border-top').previousElementSibling;
                        if (statsSection) {
                            countElement = statsSection.querySelector('strong');
                        }
                    }
                    if (countElement) {
                        countElement.textContent = data.importance_count;
                    }
                    
                    // Disable resolve button if it exists (mutually exclusive)
                    const resolveBtn = button.closest('.d-flex').querySelector('.resolve-btn');
                    if (resolveBtn) {
                        resolveBtn.disabled = true;
                        resolveBtn.classList.remove('btn-warning');
                        resolveBtn.classList.add('btn-outline-warning');
                        // Ensure rounded-pill class is present
                        if (!resolveBtn.classList.contains('rounded-pill')) {
                            resolveBtn.classList.add('rounded-pill');
                        }
                    }
                    
                    // Update resolved count if it changed
                    if (data.resolved_count !== undefined) {
                        const popupContent = button.closest('.leaflet-popup-content');
                        let resolvedCountDiv = popupContent.querySelector('.resolved-count-display');
                        if (resolvedCountDiv && data.resolved_count === 0) {
                            resolvedCountDiv.remove();
                        } else if (data.resolved_count > 0) {
                            if (!resolvedCountDiv) {
                                resolvedCountDiv = document.createElement('div');
                                resolvedCountDiv.className = 'mt-2 pt-2 border-top resolved-count-display';
                                const buttonsDiv = button.closest('.d-flex').closest('.border-top');
                                if (buttonsDiv) {
                                    buttonsDiv.parentNode.insertBefore(resolvedCountDiv, buttonsDiv);
                                }
                            }
                            resolvedCountDiv.innerHTML = `
                                <span class="small text-warning">
                                    <i class="fas fa-times-circle me-1"></i>
                                    <strong>${data.resolved_count}</strong> {{ _('reportat que ja no hi és') }}
                                </span>
                            `;
                        }
                    }
                    
                    // Show success message
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    button.closest('.d-flex').closest('.border-top').after(alert);
                } else {
                    showAlert(data.error || '{{ _("Error al votar") }}', 'error');
                    button.disabled = false;
                    button.innerHTML = '+1';
                }
            })
            .catch(error => {
                console.error('Error voting:', error);
                showAlert('{{ _("Error al votar. Intenta-ho de nou.") }}', 'error');
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-thumbs-up me-1"></i>{{ _("Confirmar importància") }}';
            });
        }
        
        // Resolve function (ya no está)
        function resolveItem(itemId, button) {
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ _("Processant...") }}';
            
            // Get CSRF token
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                           document.querySelector('input[name="csrf_token"]')?.value || 
                           '{{ csrf_token() }}';
            
            fetch(`{{ url_for('inventory.resolve_item', item_id=0) }}`.replace('0', itemId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${encodeURIComponent(csrfToken)}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update resolve button state - keep it active but disabled
                    button.disabled = true;
                    // Keep btn-warning class to show it's selected
                    // Ensure rounded-pill class is present
                    if (!button.classList.contains('rounded-pill')) {
                        button.classList.add('rounded-pill');
                    }
                    
                    // Disable vote button if it exists (mutually exclusive)
                    const voteBtn = button.closest('.d-flex').querySelector('.vote-btn');
                    if (voteBtn) {
                        voteBtn.disabled = true;
                        voteBtn.classList.remove('btn-primary');
                        voteBtn.classList.add('btn-outline-primary');
                    }
                    
                    // Update importance count if it changed
                    if (data.importance_count !== undefined) {
                        const popupContent = button.closest('.leaflet-popup-content');
                        let countElement = popupContent.querySelector('.d-flex .small strong');
                        if (!countElement) {
                            // Try finding it in the stats section
                            const statsSection = button.closest('.border-top').previousElementSibling;
                            if (statsSection) {
                                countElement = statsSection.querySelector('strong');
                            }
                        }
                        if (countElement) {
                            countElement.textContent = data.importance_count;
                        }
                    }
                    
                    // Update resolved count in popup
                    const popupContent = button.closest('.leaflet-popup-content');
                    if (popupContent) {
                        // Find or create resolved count display
                        let resolvedCountDiv = popupContent.querySelector('.resolved-count-display');
                        if (!resolvedCountDiv) {
                            // Create it if it doesn't exist
                            resolvedCountDiv = document.createElement('div');
                            resolvedCountDiv.className = 'mt-2 pt-2 border-top resolved-count-display';
                            const buttonsDiv = button.closest('.d-flex').closest('.border-top');
                            if (buttonsDiv) {
                                buttonsDiv.parentNode.insertBefore(resolvedCountDiv, buttonsDiv);
                            }
                        }
                        resolvedCountDiv.innerHTML = `
                            <span class="small text-warning">
                                <i class="fas fa-times-circle me-1"></i>
                                <strong>${data.resolved_count}</strong> {{ _('reportat que ja no hi és') }}
                            </span>
                        `;
                    }
                    
                    // If auto-resolved, show message and reload items
                    if (data.auto_resolved) {
                        setTimeout(function() {
                            window.showToast('{{ _("Item tancat") }}', '{{ _("Aquest item s\'ha tancat automàticament després de múltiples confirmacions que ja no hi és.") }}', 'warning');
                            // Reload items to update map
                            setTimeout(() => location.reload(), 2000);
                        }, 1500);
                    } else {
                        // Show success message
                        const alert = document.createElement('div');
                        alert.className = 'alert alert-success alert-dismissible fade show mt-2';
                        alert.innerHTML = `
                            <i class="fas fa-check-circle me-2"></i>${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        button.closest('.d-flex').closest('.border-top').after(alert);
                    }
                } else {
                    // Mostrar error inline en el popup
                    const popup = button.closest('.leaflet-popup-content');
                    if (popup) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>${data.error || '{{ _("Error al reportar") }}'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        popup.appendChild(alertDiv);
                    } else {
                        showAlert(data.error || '{{ _("Error al reportar") }}', 'error');
                    }
                    button.disabled = false;
                    // Ensure rounded-pill class is present
                    if (!button.classList.contains('rounded-pill')) {
                        button.classList.add('rounded-pill');
                    }
                    button.innerHTML = '<i class="fas fa-times-circle me-1"></i>{{ _("Ja no hi és") }}';
                }
            })
            .catch(error => {
                console.error('Error resolving item:', error);
                const popup = button.closest('.leaflet-popup-content');
                if (popup) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-2';
                    alertDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle me-2"></i>{{ _("Error al reportar. Intenta-ho de nou.") }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    popup.appendChild(alertDiv);
                } else {
                    showAlert('{{ _("Error al reportar. Intenta-ho de nou.") }}', 'error');
                }
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-times-circle me-1"></i>{{ _("Ja no hi és") }}';
            });
        }
        
        // Share function - always show modal (no native share)
        function shareItem(url, title, itemId) {
            openShareModal(url, title, itemId);
        }
        
        // Function to increment share count
        function incrementShareCount(itemId) {
            console.log('Incrementing share count for item:', itemId);
            if (!itemId) {
                console.error('No itemId provided');
                return;
            }
            fetch(`/inventory/api/items/${itemId}/share`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Share count response:', data);
                if (data.success) {
                    // Update share count in popup if visible
                    const shareCountSpan = document.querySelector(`[data-item-id="${itemId}"]`)?.closest('.leaflet-popup-content')?.querySelector('.text-info strong');
                    if (shareCountSpan && shareCountSpan.textContent) {
                        shareCountSpan.textContent = data.share_count;
                    }
                }
            })
            .catch(error => {
                console.error('Error incrementing share count:', error);
            });
        }
        
        // Open share modal
        function openShareModal(url, title, itemId) {
            // Create a temporary element with share modal
            const shareDiv = document.createElement('div');
            const shareText = title + ' ' + url;
            shareDiv.innerHTML = `
                <div class="modal fade" id="shareModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">{{ _('Compartir') }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body text-center">
                                <p class="mb-3">{{ _('Comparteix aquest item a les xarxes socials') }}</p>
                                <div class="d-flex justify-content-center gap-3">
                                <a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}" 
                                   target="_blank" 
                                   class="btn btn-lg rounded-circle d-flex align-items-center justify-content-center share-facebook-btn" 
                                   data-item-id="${itemId}"
                                   style="width: 50px; height: 50px; background-color: #1877F2; border: none; padding: 0;">
                                    <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                                        <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                                    </svg>
                                </a>
                                <a href="https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}" 
                                   target="_blank" 
                                   class="btn btn-lg rounded-circle d-flex align-items-center justify-content-center share-twitter-btn" 
                                   data-item-id="${itemId}"
                                   style="width: 50px; height: 50px; background-color: #1DA1F2; border: none; padding: 0;">
                                    <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                                        <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
                                    </svg>
                                </a>
                                <a href="https://wa.me/?text=${encodeURIComponent('¡Epp! ¡Mira què hi ha aquí! 📸\n\n' + title + '\n\n' + url)}" 
                                   target="_blank" 
                                   class="btn btn-lg rounded-circle d-flex align-items-center justify-content-center share-whatsapp-btn" 
                                   data-item-id="${itemId}"
                                   style="width: 50px; height: 50px; background-color: #25D366; border: none; padding: 0;">
                                    <svg width="24" height="24" fill="white" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                </a>
                                <button id="share-link-btn" 
                                        class="btn btn-secondary btn-lg rounded-circle d-flex align-items-center justify-content-center" 
                                        data-item-id="${itemId}"
                                        style="width: 50px; height: 50px; padding: 0;">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                        <path d="M4.715 6.542 3.343 7.914a3.201 3.201 0 0 0 4.486 4.486l1.828-1.829a3.2 3.2 0 0 0 0-4.486l-1.829-1.828-1.414 1.414z"/>
                                        <path d="M6.586 4.672V3.39a1.5 1.5 0 0 1 1.5-1.5h5.976a1.5 1.5 0 0 1 1.5 1.5v5.976a1.5 1.5 0 0 1-1.5 1.5h-2.282l-1.414-1.414h2.282V3.39H8.086v1.282H6.586z"/>
                                        <path d="M11.314 4.672V3.39a1.5 1.5 0 0 0-1.5-1.5H3.928a1.5 1.5 0 0 0-1.5 1.5v5.976a1.5 1.5 0 0 0 1.5 1.5h2.282v1.282H3.928a2.5 2.5 0 0 1-2.5-2.5V3.39a2.5 2.5 0 0 1 2.5-2.5h5.886a2.5 2.5 0 0 1 2.5 2.5v1.282z"/>
                                    </svg>
                                </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(shareDiv);
            
            // Wait for modal to be in DOM before adding event listeners
            setTimeout(function() {
                const modalItemId = itemId;
                console.log('Setting up share buttons for item:', modalItemId);
                const shareButtons = document.querySelectorAll('.share-facebook-btn, .share-twitter-btn, .share-whatsapp-btn');
                console.log('Found share buttons:', shareButtons.length);
                shareButtons.forEach(function(btn) {
                    btn.addEventListener('click', function(e) {
                        console.log('Share button clicked, itemId:', modalItemId);
                        incrementShareCount(modalItemId);
                    });
                });
                
                const linkBtn = document.getElementById('share-link-btn');
                if (linkBtn) {
                    linkBtn.addEventListener('click', function() {
                        navigator.clipboard.writeText(url).then(function() {
                            incrementShareCount(modalItemId);
                            window.showToast('Enllaç copiat! 🔗', 'URL copiada al portapapers', 'success');
                            document.getElementById('shareModal').querySelector('[data-bs-dismiss]').click();
                        });
                    });
                }
            }, 100);
            
            // La función showToast ya está definida globalmente arriba
            
            const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
            shareModal.show();
            // Remove modal from DOM after it's hidden
            document.getElementById('shareModal').addEventListener('hidden.bs.modal', function() {
                shareDiv.remove();
            });
        }
    });
</script>
{% endblock %}

